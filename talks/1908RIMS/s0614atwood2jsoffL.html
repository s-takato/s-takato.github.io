<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    
    <title>atwood2.cdy</title>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }

        #CSConsole {
            background-color: #FAFAFA;
            border-top: 1px solid #333333;
            bottom: 0px;
            height: 200px;
            overflow-y: scroll;
            position: fixed;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="ketcindyjs/CindyJS.css">
   <script type="text/javascript" src="ketcindyjs/Cindy.js"></script>

<script id="csinit" type="text/x-cindyscript">
Ketinit():=Ketinit("fig",1,[-5,5],[-5,5]); //181001
Ketinit(Arg):=(//181001from
  if(isstring(Arg),
     Ketinit(Arg,1,[-5,5],[-5,5]);
  ,
    Ketinit("fig",Arg,[-5,5],[-5,5]);
  );
);
Ketinit(work,sy,rangex,rangey):=(//181001to
 regional(pt,tmp,tmp1,tmp2,letterc,boxc,shadowc,mboxc);
  PenThickInit=8;
  ULEN="1cm";
  MEMORI=0.05;//18.01.15from
  MEMORIInit=MEMORI;
  MEMORINow=MEMORI;
  MARKLEN=0.05;
  MARKLENInit=MARKLEN; //180504
  MARKLENNow= MARKLEN;
  GENTEN=[0,0];//18.01.15to
  TABLECOUNT=0; //190428
  KETPICLAYER=20;
  MilliIn=1/2.54*1000;
  PenThick=round(MilliIn*0.02);
  PenThickInit=PenThick;
  TenSizeInit=0.02;
  TenSize=TenSizeInit;
  YaSize=1; YaAngle=18; YaPosition=1;
  YaCut=0; YasenStyle="dr,1"; Yajiristyle="tf";
  KETPICCOUNT=1;
  KCOLOR=[0,0,0];
  GCLIST=[];
  VLIST=[];
  FUNLIST=[];
  LETTERlist=[];
  ADDAXES="1";
  AXSTYLE=["l","x","e","y","n","O","sw","","",""]; //181216
  AXCOUNT=1; //181215
  SHADECTR=1; //190222
  LFmark=unicode("000a");
  CRmark=unicode("000d");//16.12.13
  Dq=unicode("0022");
  Fillstore(); //181212
  ArrowlineNumber=1;  // 15.01.05
  ArrowheadNumber=1;
  BezierNumber=1; //15.01.03
  SCALEX=1;
  SCALEY=sy;
  XMIN=rangex_1/SCALEX;
  XMAX=rangex_2/SCALEX;
  YMIN=rangey_1/SCALEY;
  YMAX=rangey_2/SCALEY;
  Setwindow("Msg=n"); // 16.05.31
);
Indexall(str,key):=(
  regional(rest,out,flg,tmp,tmp1,);
  out=[];
  rest=str;
  flg=0;
  forall(1..(length(str)),
    if(flg==0,
      tmp=indexof(rest,key);
      if(tmp>0,
        tmp1=tmp+length(str)-length(rest);
        out=append(out,tmp1);
        rest=substring(rest,tmp,length(rest));
      ,
        flg=1;
      );
    );
  );
  out;
);
Setwindow():=Setwindow("Msg=yes");
Setwindow(str):=(
  regional(tmp,tmp1,tmp2,msg);
  msg="y";
  tmp=indexof(str,"="); // 16.02.10
  tmp1=Toupper(substring(str,tmp,tmp+1));
  if(tmp1=="N",msg="n");
  if((ispoint(SW) & ispoint(NE)),
    tmp1=Lcrd(SW);
    tmp2=Lcrd(NE);
    XMIN=tmp1_1; XMAX=tmp2_1;
    YMIN=tmp1_2; YMAX=tmp2_2;
  ,
    Putpoint("SW",Pcrd([XMIN,YMIN]));
    Putpoint("NE", Pcrd([XMAX,YMAX])); 
  );
);
Setwindow(xrange,yrange):=(
  XMIN=xrange_1;
  XMAX=xrange_2;
  YMIN=yrange_1;
  YMAX=yrange_2;
  Putpoint("SW",[XMIN,YMIN]);//181016
  Putpoint("NE",[XMAX,YMAX]);//181016
);
Toupper(str):=(
  regional(alphabet,out,tmp,tmp1);
  alphabet="abcdefghijklmnopqrstuvwxyz";
  out="";
  forall(1..(length(str)),
    tmp=substring(str,#-1,#);
    tmp1=indexof(alphabet,tmp);
    if(tmp1>0,
      out=out+unicode(text(tmp1+64),base->10);
    ,
      out=out+tmp;
    );
  );
  out;
);
Lcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=[pt.x/SCALEX,pt.y/SCALEY];
  ,
    tmp=pt;
  );
  tmp;
);
Pcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=re(pt.xy); // 15.07.24
  ,
    tmp=[pt_1*SCALEX,pt_2*SCALEY];
  );
 tmp;
);
Putpoint(name,Pt):=Putpoint(name,Pt,Pt);
Putpoint(name,Ptinit,Pt):=(
  regional(ptstr);
    ptstr=name+".xy="+Textformat(Pcrd(Pt),5)+";";
    parse(ptstr);
);
Textformat(value,dig):=(
  regional(vv,tmp,tmp1);
  if(islist(value),
    tmp1="[";
    forall(value,
      tmp1=tmp1+Textformat(#,dig)+",";
    );
    if(length(tmp1)>1, //18.01.29from
      tmp1=substring(tmp1,0,length(tmp1)-1);
    );
    tmp1=tmp1+"]"; //18.01.29until
  ,
    if(ispoint(value) % isstring(value),
      if(isstring(value),tmp1=Dq+value+Dq,tmp1=text(value)); // 15.10.02
    ,
      tmp1=format(value,dig);
    );
  );
  tmp1;
);
Setax(arglist):=(
  regional(st,nn,tmp); //181215from
  st=1; nn=1;
  if(isreal(arglist_1),
    st=2;
    nn=arglist_1;
  );
  forall(st..(length(arglist)),
    tmp=arglist_#;
    if(length(tmp)>0,AXSTYLE_nn=tmp);
    nn=nn+1;
  ); //181215from
);
Textedit(no):=(
  regional(tmp,tmp1,tmp2);
  tmp="Text"+text(no)+".currenttext";
  tmp1=parse(tmp);
  tmp1;
);
Strsplit(str,key):=( //180505
  regional(start,out,tmp1,tmp2);
  tmp1=Indexall(str,key);
  out=[]; start=0;
  forall(tmp1,
    out=append(out,substring(str,start,#-1));
    start=#;
  );
  out=append(out,substring(str,start,length(str)));
  out;
);
Assign(str):=( //190125from
  regional(tmp);
  tmp=[];
  forall(VLIST,tmp=concat(tmp,[#_1,#_2]));
  Assign(str,tmp);
); //190125to
Assign(funstr,vrL):=(
  regional(nn,out);
  nn=length(vrL)/2;
  out=funstr;
  forall(1..nn,
    out=Assign(out,vrL_(2*#-1),vrL_(2*#));
  );
  out;
);
Assign(funstr,varname,rep):=(
  regional(repstr,ii,jj,tmp,tmp1,tmp2,Notvar,Flg);
  if(isstring(rep),repstr=rep,repstr="("+Textformat(rep,6)+")");
  tmp=[46];  // 12.20
  tmp=concat(tmp,48..57);
  tmp=concat(tmp,65..90);
  tmp=concat(tmp,97..122);
  Notvar=apply(tmp,unicode(text(#),base->10));
  tmp2="";
  forall(1..100,
    ii=indexof(funstr,varname);
    if(ii>0,
      Flg=0;
      if(ii>1,
        tmp=substring(funstr,ii-2,ii-1);
        if(contains(Notvar,tmp),
          tmp2=tmp2+substring(funstr,0,ii);
          funstr=substring(funstr,ii,length(funstr));
          Flg=1;
        );
      );
      if(Flg==0,
        jj=ii-1+length(varname);
        if(jj<length(funstr),
          tmp=substring(funstr,jj,jj+1));
          if(contains(Notvar,tmp),
          tmp2=tmp2+substring(funstr,0,jj);
          funstr=substring(funstr,jj,length(funstr));
          Flg=1;
        );
      );
      if(Flg==0,
        tmp2=tmp2+substring(funstr,0,ii-1)+repstr;
        funstr=substring(funstr,jj,length(funstr));
      );
    );
  );
  funstr=tmp2+funstr;
  funstr;
);
Deqdata(deq,rng,initt,initf,Num):=( //17.10.04
  regional(Eps,Inf,tname,Xname,func,t1,t2,dt,tt,X0,flg,
                 kl1,kl2,kl3,kl4,pdL,tmp,tmp1,tmp2);
  Eps=10^(-3);
  Inf=10^3;
  tmp=tokenize(deq,"=");
  tmp1=replace(tmp_1,"`",""); tmp1=replace(tmp1,"'","");//190410
  tmp1=substring(tmp1,1,length(tmp1)-1);
  Xname=tokenize(tmp1,",");
  func=tmp_2;
  forall(1..(length(Xname)),
    func=replace(func,Xname_#,"X_"+text(#));
  );
  tmp=tokenize(rng,"=");
  tname=tmp_1;
  tmp=parse(tmp_2);
  t1=tmp_1;
  t2=tmp_2;
  tmp="funP("+tname+",X):="+func+";";
  parse(tmp);
  tmp="funN("+tname+",X):=-"+func+";";
  parse(tmp);
  dt=(t2-t1)/Num;
  tt=initt;
  X0=Lcrd(initf);
  pdL=[flatten([tt,X0])];
  flg=0;
  forall(1..(round((t2-initt)/dt)), //190523
    if(flg==0,
      kl1=dt*funP(tt,X0);
      kl2=dt*funP(tt+dt/2,X0+kl1/2);
      kl3=dt*funP(tt+dt/2,X0+kl2/2);
      kl4=dt*funP(tt+dt,X0+kl3);
      X0=X0+(kl1+2*kl2+2*kl3+kl4)/6;
      tt=initt+#*dt;
      tmp=flatten([tt,X0]);
      pdL=append(pdL,tmp);
      if(|tmp|>Inf,flg=1);
    );
  );
  tt=initt;
  X0=Lcrd(initf);
  flg=0;
  forall(1..(round((initt-t1)/dt)), //190523
    if(flg==0,
      kl1=dt*funN(tt,X0);
      kl2=dt*funN(tt+dt/2,X0+kl1/2);
      kl3=dt*funN(tt+dt/2,X0+kl2/2);
      kl4=dt*funN(tt+dt,X0+kl3);
      X0=X0+(kl1+2*kl2+2*kl3+kl4)/6;
      tt=initt-#*dt;
      tmp=flatten([tt,X0]);
      pdL=prepend(tmp,pdL);
      if(|tmp1|>Inf,flg=1);
    );
  );
  pdL;
);
Circledata(cenrad):=Circledata(cenrad,[]);
Circledata(para1,para2):=(
  regional(name,cenrad,options,str,n); 
  if(isstring(para1), 
    name=para1;
    cenrad=para2;
    options=[];
    ,
    cenrad=para1;
    options=para2;
    name="";// 16.10.07from
    forall(cenrad, 
       name=name+#.name;
    );// 16.10.07until
  );
  Circledata(name,cenrad,options);
);
Circledata(nm,cenrad,options):=(
  regional(name,Out,Ctr,Ptcir,ra,Num,Rg,opstr,opcindy,color,Msg,
      tmp,tmp1,tmp2,Th,Ltype,Noflg,eqL,pA,pB,pC,d1,d2,Eps);  
  name="cr"+nm;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Num=50;
  Rg=[0,2*pi];
  Msg="Y";
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(substring(#,0,1)=="N",
      Num=parse(tmp_2);
     opstr=opstr+",'"+#+"'";
    );
    if(substring(#,0,1)=="R",
      Rg=parse(tmp_2);
      opstr=opstr+",'"+#+"'";
    );
    if(tmp1=="M", //190206from
      Msg=Toupper(substring(tmp_2,0,1));
    ); //190206to
  );
  if(length(cenrad)==2,
    Ctr=Lcrd(cenrad_1);
    Ptcir=Lcrd(cenrad_2);
    if(!islist(Ptcir),  //190323from
      Ptcir=Ctr+[Ptcir,0];
    );  //190323to
    ra=dist(Ctr,Ptcir);
  ,
    Eps=10^(-1);
    pA=Lcrd(cenrad_1);
    pB=Lcrd(cenrad_2);
    pC=Lcrd(cenrad_3);
    tmp=pB-pA;
    tmp1=(tmp_2,-tmp_1);
    tmp=pC-pB;
    tmp2=(tmp_2,-tmp_1);
    d1=det([tmp1,tmp2]);
    d2=det([pC-pA,tmp2]);
    if(abs(d1)<Eps & abs(d2)>10*Eps,
      println("points are in a line");
      ra=0;
    ,
      Ctr=1/2*(pA+pB)+1/2*d2/d1*tmp1;
      ra=|pA-Ctr|;
      tmp=name+"center="+Textformat(Ctr,5)+";";
      parse(tmp);
      Defvar(name+"center",re(Ctr));
    );
  );
  if(ra>0,
    Out=[];
    forall(0..Num,
      Th=Rg_1+#*(Rg_2-Rg_1)/Num;
      Out=append(Out,Ctr+ra*[cos(Th),sin(Th)]);
    );
  ,
    Out=Lineplot("1",[pA,pB],["nodata"]);
  );
  if(Noflg<3,
    if(Msg=="Y", //190206
      println("generate Circledata "+name);
    );
    tmp1=apply(Out,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,5)+";"; //190415
    parse(tmp);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  Out;
);
Divoptions(options):=(
  regional(Ltype,Noflg,Inflg,Outflg,eqL,realL,strL,color,opstr,opcindy,flg,
       tmp,tmp1,tmp2);
  Ltype="dr";  // 2015.01.13
  Noflg=0;
  Inflg=0;
  Outflg=0;
  eqL=[];
  realL=[];
  strL=[];
  color=KCOLOR; //180603
  opstr="";
  opcindy="";
  forall(options,
    flg=0;
    if(flg==0,
      if(isreal(#) % ispoint(#) % islist(#),
        realL=append(realL,#);
        opstr=opstr+","+text(#);
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"=")>0,
        tmp=Strsplit(#,"="); //180602from
        tmp1=Toupper(tmp_1);
        tmp2=tmp_2;
        if(tmp1=="COLOR",
          if(indexof(tmp2,"[")>0, //180928
            tmp1=parse(tmp2);
            color=tmp1;
            if(length(tmp1)==4,
              tmp1=Colorcmyk2rgb(tmp1);
            );
          ,
            tmp1=Colorname2rgb(tmp2); color=tmp1; //181212
         );
          tmp="color->"+text(tmp1);
          opcindy=opcindy+","+tmp;
        ,
          eqL=append(eqL,#);
        );//180602to
        flg=1; 
      );
    );
    if(flg==0,
      if(indexof(#,"no")+indexof(#,"No")>0,
        if(indexof(#,"tex")>0,Noflg=1);
        if(indexof(#,"disp")>0,Noflg=2);
        if(indexof(#,"data")>0,Noflg=3);
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"->")>0,
        opcindy=opcindy+","+#;
        flg=1; 
      );
    );
    if(flg==0,
      if(indexof(#,"out")+indexof(#,"Out")>0,
        if(indexof(#,"-")==0,
          Outflg=1;
        ,
          Outflg=2;
        );
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"in")+indexof(#,"In")>0,
        if(indexof(#,"-")==0,
          Inflg=1;
        ,
          Inflg=2;
        );
        flg=1;
      );
    );
    if(flg==0,
      tmp=substring(#,0,2);
      tmp1=indexof(tmp,"dr")+indexof(tmp,"Dr");
      tmp1=tmp1+indexof(tmp,"da")+indexof(tmp,"Da");
      tmp1=tmp1+indexof(tmp,"id")+indexof(tmp,"Id");
      tmp1=tmp1+indexof(tmp,"do")+indexof(tmp,"Do");
      tmp1=tmp1+indexof(tmp,"dp")+indexof(tmp,"Dp");
      if(tmp1>0,
        Ltype=#;
        flg=1;
      );
      if(flg==0,
        if(length(#)>0, //180408
          strL=append(strL,#);
          opstr=opstr+","+Dq+#+Dq;
        );
      );
    );
  );
  if(indexof(opcindy,"color->")==0,// 16.10.07from
    opcindy=opcindy+",color->"+text(KCOLOR);
  );
  [Ltype,Noflg,Inflg,Outflg,eqL,realL,strL,color,opstr,opcindy];
);
Colorcmyk2rgb(clr):=(
  regional(clrnew,tmp,black);
  black=clr_4;
  tmp=apply(clr,1-min(1,#*(1-black)+black));
  clrnew=tmp_(1..3);
  clrnew;
);
Colorname2rgb(name):=( //181212
  regional(dL,nameL,codeL,tmp);
  dL=[
    ["greenyellow",[0.15,0,0.69,0]],["yellow",[0,0,1,0]],
    ["goldenrod",[0,0.1,0.84,0]],["dandelion",[0,0.29,0.84,0]],
    ["apricot",[0,0.32,0.52,0]],["peach",[0,0.5,0.7,0]],
    ["melon",[0,0.46,0.5,0]],["yelloworange",[0,0.42,1,0]],
    ["orange",[0,0.61,0.87,0]],["burntorange",[0,0.51,1,0]],
    ["bittersweet",[0,0.75,1,0.24]],["redorange",[0,0.77,0.87,0]],
    ["mahogany",[0,0.85,0.87,0.35]],["maroon",[0,0.87,0.68,0.32]],
    ["brickred",[0,0.89,0.94,0.28]],["red",[0,1,1,0]],
    ["orangered",[0,1,0.5,0]],["rubinered",[0,1,0.13,0]],
    ["wildstrawberry",[0,0.96,0.39,0]],["salmon",[0,0.53,0.38,0]],
    ["carnationpink",[0,0.63,0,0]],["magenta",[0,1,0,0]],
    ["violetred",[0,0.81,0,0]],["rhodamine",[0,0.82,0,0]],
    ["mulberry",[0.34,0.9,0,0.02]],["redviolet",[0.07,0.9,0,0.34]],
    ["fuchsia",[0.47,0.91,0,0.08]],["lavender",[0,0.48,0,0]],
    ["thistle",[0.12,0.59,0,0]],["orchid",[0.32,0.64,0,0]],
    ["darkorchid",[0.4,0.8,0.2,0]],["purple",[0.45,0.86,0,0]],
    ["plum",[0.5,1,0,0]],["violet",[0.79,0.88,0,0]],
    ["royalpurple",[0.75,0.9,0,0]],["blueviolet",[0.86,0.91,0,0.04]],
    ["periwinkle",[0.57,0.55,0,0]], ["cadetblue",[0.62,0.57,0.23,0]],
    ["cornflowerblue",[0.65,0.13,0,0]],["midnightblue",[0.98,0.13,0,0.43]],
    ["navyblue",[0.94,0.54,0,0]],["royalblue",[1,0.5,0,0]],
    ["blue",[1,1,0,0]],["cerulean",[0.94,0.11,0,0]],
    ["cyan",[1,0,0,0]],["processblue",[0.96,0,0,0]],
    ["skyblue",[0.62,0,0.12,0]],["turquoise",[0.85,0,0.2,0]],
    ["tealblue",[0.86,0,0.34,0.02]],["aquamarine",[0.82,0,0.3,0]],
    ["bluegreen",[0.85,0,0.33,0]],["emerald",[1,0,0.5,0]],
    ["junglegreen",[0.99,0,0.52,0]],["seagreen",[0.69,0,0.5,0]],
    ["green",[1,0,1,0]],["forestgreen",[0.91,0,0.88,0.12]],
    ["pinegreen",[0.92,0,0.59,0.25]],["limegreen",[0.5,0,1,0]],
    ["yellowgreen",[0.44,0,0.74,0]],["springgreen",[0.26,0,0.76,0]],
    ["olivegreen",[0.64,0,0.95,0.4]],["rawsienna",[0,0.72,1,0.45]],
    ["sepia",[0,0.83,1,0.7]],["brown",[0,0.81,1,0.6]],
    ["tan",[0.14,0.42,0.56,0]],["gray",[0,0,0,0.5]],
    ["lightgray",[0,0,0,0.15]], //190429,0809
    ["cindycolor",[0.66,0,69,0.71]], //190504
    ["black",[0,0,0,1]],["white",[0,0,0,0]],["offwhite",[0,0,0,0.03]] //190809
  ];
  tmp=select(dL,#_1==name);
  if(length(tmp)>0,
    tmp=tmp_1;
    code=tmp_2;
    code=Colorcmyk2rgb(code);
  ,
    println("    "+name+" not found");
    code=Assign(name); //190323
  );
);
Defvar(varstr):=(
  regional(name,value,tmp,tmp1);
  if(isstring(varstr),
    parse(varstr+";");
    tmp=indexof(varstr,"=");
    name=substring(varstr,0,tmp-1);
    value=substring(varstr,tmp,length(varstr));
    value=parse(value);
    tmp1=select(1..length(VLIST),VLIST_#_1==name);
    if(length(tmp1)>0,
      tmp=tmp1_1;
      VLIST_tmp=[name,value];
    ,
      VLIST=prepend([name,value],VLIST);
    );
  ,
    forall(1..(length(varstr)/2), // 16.11.16from
      name=varstr_(2*#-1);
      value=varstr_(2*#);
      Defvar(name,value);
    ); // 16.11.16until
  );
);
Defvar(name,value):=(
  regional(tmp,tmp1);
  if(islist(value),
    tmp1="[";
    forall(value,
      if(isstring(#), // 16.11.14
        tmp1=tmp1+Dq+#+Dq+","; // 16.11.14
      ,
        tmp1=tmp1+format(#,5)+",";
      );
    );
    tmp1=substring(tmp1,0,length(tmp1)-1)+"]";
  ,
    tmp1=format(value,5);
  );
  tmp=name+"="+tmp1+";"; // 15.02.06//190415
  parse(tmp);
  VLIST=select(VLIST,#_1!=name); // 15.02.08
  VLIST=prepend([name,value],VLIST);
);
Lineplot(nm,list,optionorg):=(
  regional(name,Out,tmp,tmp1,tmp2,opstr,opcindy,Mag,Semi,
      Vec,pA,pB,options,Ltype,Noflg,color,Msg,eqL);
  name="ln"+nm;
  options=optionorg;
  Mag=100;
  Semi="";
  Msg="Y";
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  opstr=tmp_(length(tmp)-1);
  eqL=tmp_5;
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="M", //190206from
      Msg=Toupper(substring(tmp_2,0,1));
      options=remove(options,[#]);
    ); //190206to
  );
  tmp=Divoptions(options);
  opstr=tmp_(length(tmp)-1);
  tmp1=tmp_6;
  if(length(tmp1)>0,Mag=tmp1_1);
  tmp1=tmp_7;
  if(length(tmp1)>0,Semi=tmp1_1);
  pA=Lcrd(list_1); pB=Lcrd(list_2);
  Vec= Mag/dist(pA,pB)*(pB-pA);
  if(length(Semi)==0,
    Out=[pA-Vec,pA+Vec];
  ,
    if(Semi=="+",   
      Out=[pA,pA+Vec];
    ,
      Out=[pA-Vec,pA];
    );
  );
  if(Noflg<3,
    if(Msg=="Y", //190206
      println("generate Lineplot "+name);
    );
    tmp1=apply(Out,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,5)+";"; //190415
    parse(tmp);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  Out;
);
Lineplot(Arg1,Arg2):=(
  regional(name,list,options,str);
  if(isstring(Arg1),
    name=Arg1;
    list=Arg2;
    Lineplot(name,list,[]);
  ,
    list=Arg1;
    options=Arg2;
    name="";
    forall(list, // 16.10.07from
       name=name+#.name;
    );// 16.10.07until
    Lineplot(name,list,options);
  );
);
Lineplot(list):=Lineplot(list,[]);
Getlinestyle(str,name):=(
  regional(noflg,tmp,tmp1,tmp2,Dop,Ltype,subflg);
  Ltype=-1;
  Dop="";
  tmp1=indexof(str,",");
  if(tmp1>0,
    Dop=","+substring(str,tmp1,length(str));
  );
  noflg=parse(substring(str,0,1));
  if(substring(name,0,3)=="sub",subflg=1,subflg=0);  // 16.02.29
  tmp1=substring(str,1,3);
  tmp2=""; //190119from
  tmp=indexof(str,",");
  if(tmp>0,
    tmp2=substring(str,tmp,length(str));
  ); //190119to
  if(tmp1=="dr" % tmp1=="Dr",
    if(length(tmp2)==0,tmp2="1"); //190125
    Ltype=[0,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
      Drwline(name+Dop);
    );
  );
  if(tmp1=="da" % tmp1=="Da",
    if(length(tmp2)==0,tmp2="1,1"); //190125
    Ltype=[1,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
      Dashline(name+Dop);
    );
  );
  if(tmp1=="id" % tmp1=="Id",
     if(length(tmp2)==0,tmp2="1,1"); //190125
   Ltype=[2,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
      Invdashline(name+Dop);
    );
  );
  if(tmp1=="do" % tmp1=="Do",
    if(length(tmp2)==0,tmp2="1,1"); //190125
    Ltype=[3,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
      Dottedline(name+Dop);
    );
  );
  if(tmp1=="dp" % tmp1=="Dp",
    if(length(tmp2)==0,tmp2="1"); //190125
    Ltype=[0,tmp2];  //190119
    tmp1=parse(name);
    tmp2="";
    forall(tmp1,
      tmp2=tmp2+Textformat(#_1,5)+",";
    );
    tmp2=substring(tmp2,0,length(tmp2)-1);
    if(noflg==0,
      Drwpt(tmp2+Dop);
    );
  );
  if(tmp1=="no" % tmp1=="No",
    Ltype=10;
  );
  Ltype;
);
Dashline(gstr):=(
  Com2nd("Dashline("+gstr+")");
);
Drwpt(pstr):=Drwpt(pstr,1); //181231
Drwpt(ptlist,nn):=(  // 16.03.05 from
  if(!isreal(DrwPtCtr), //181231from
    DrwPtCtr=1;
  );
  Pointdata(text(DrwPtCtr),ptlist,["Inside="+text(nn)]);
  DrwPtCtr=DrwPtCtr+1; //181231to
);
Pointdata(nm,list):=Pointdata(nm,list,[]);
Pointdata(nm,listorg,options):=(
  regional(list,name,nameL,ptlist,opstr,opcindy,Msg,
      eqL,dispflg,size,thick,tmp,tmp1,tmp2,tmp3,
      Ltype,Noflg,color,inside,border);
  name="pt"+nm;
  nameL=name+"L";
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  opstr=tmp_(length(tmp)-1);
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  size="";
  dispflg="Y";
  inside=color;
  border="Y";
  Msg="Y";
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="S",
      size=tmp_2; //190406from
      tmp1=parse(size);
      opcindy=opcindy+",size->"+text(tmp1); //190409to
    );
    if(tmp1=="D", //181030from
      dispflg=Toupper(substring(tmp_2,0,1));
    );
    if(tmp1=="I", //190628from
      tmp2=Toupper(substring(tmp_2,0,1));
      if(tmp2=="[",
        tmp=parse(tmp_2);
        if(length(tmp)==4,
          tmp=Colorcmyk2rgb(tmp);
        );
        inside=text(tmp);
      ,
        if(contains(["0","1"],tmp2),
          tmp=[1,1,1]-color;
          tmp=parse(tmp_2)*tmp;
          inside=[1,1,1]-tmp;
        ,
          if(tmp2=="N",
            inside=[1,1,1];
          ,
            inside=Colorname2rgb(tmp_2);
          );
        );
        tmp1=indexof(opcindy,"color->");
        tmp=substring(opcindy,tmp1,length(opcindy));
        tmp2=indexof(tmp,"]");
        tmp=substring(tmp,tmp2,length(tmp));
        opcindy=substring(opcindy,0,tmp1-1)+"color->"+text(inside)+tmp;
      );
    );  //190628to
    if(tmp1=="B", //1810628from
      border=Toupper(substring(tmp_2,0,1));
      if(border=="N",
        opcindy=opcindy+",border->false";
      );
    ); //1810628to
    if(tmp1=="M", //190206from
      Msg=Toupper(substring(tmp_2,0,1));
    ); //190206to
  );
  if(dispflg=="Y", 
    if(Msg=="Y", //190206
      println("generate pointdata "+name);
    );
  ); //181030to
  if(isstring(listorg),
    list=parse(listorg);
  ,
    list=listorg;
   ); //17.10.23
  list=apply(list,Lcrd(#));  //190426
  if(Measuredepth(list)==0,list=[list]);//180530
  tmp=Measuredepth(list);
  if(tmp==1,ptlist=list,ptlist=list_1); //190126from
  tmp=apply(ptlist,[Textformat(Pcrd(#),5)]);
  tmp1=text(tmp);
  tmp2=substring(tmp1,1,length(tmp1)-1);
  tmp3=tmp1;
  tmp=parse(tmp1);
  if(length(tmp)==1, //190301from
    tmp1=Textformat(tmp_1,5);
  ); //190301to
  tmp=name+"="+tmp1+";"; //190415
  parse(tmp);
  tmp=nameL+"="+tmp3+";"; //190415
  parse(tmp); //190126to
  if(Noflg<3,
    if(isstring(listorg), //17.10.23
      tmp2=listorg;
    ,
      tmp2="list"+PaO(); //17.10.10from
      forall(list,
        if(isstring(#),
          tmp=#;
        ,
          if(ispoint(#),
            tmp=#.name; //190505
          ,
            tmp=Textformat(#,6);
          );
        );
        tmp2=tmp2+tmp+",";
      );
      tmp2=substring(tmp2,0,length(tmp2)-1)+")";
    );
  );
  if(Noflg<2,
    tmp=[nameL,[0,1],opcindy];  //190126
    GCLIST=append(GCLIST,tmp);
    if(Noflg==0,
      if(length(size)>0,
        Com2nd("Setpt("+size+")");
      );
      thick=PenThick/PenThickInit;  // 16.04.09
      opstr=","+Textformat(inside,2);
      Com2nd("Drwpt"+PaO()+"list"+PaO()+name+")"+opstr+")");
    );
  );
  ptlist;
);
Measuredepth(list):=( //190423
  regional(str,nn,tmp,tmp1,tmp2);
  str=text(list);
  tmp1=Indexall(str,"[");
  tmp2=select(tmp1,!contains(tmp1,#+1));
  nn=tmp2_1;
  tmp1=substring(str,nn,length(str));
  tmp=indexof(tmp1,",");
  tmp1=substring(tmp1,0,tmp-1);
  if(!ispoint(parse(tmp1)),
    nn=nn-1;
  );
  nn;
);
PaO():=PaO("");
PaO(Arg):=(
  regional(out);
  if(isstring(Arg),
    out="("+Arg;
  ,
    out="";
    repeat(Arg,
      out=out+"(";
    );
  );
  out;
);
Shade(plist):=Shade(plist,[]); 
Shade(Arg1,Arg2):=(
  if(!isstring(Arg1),
    Shade(text(SHADECTR),Arg1,Arg2); //190222
  ,
    Shade(Arg1,Arg2,[]);
  );
);
Shade(nm,plistorg,options):=(
  regional(name,plist,jj,nn,trim,tmp,tmp1,tmp2,
     opstr,opcindy,eqL,reL,Str,G2,flg,encflg,startpt,color,ctr);
  name="shade"+nm;
  plist=plistorg;
  if(isstring(plist_1), // 16.01.24
    println("output Shade of "+plist);
  ,
    println("output Shade of lists");
  );
  tmp=Divoptions(options);
  eqL=tmp_5; 
  reL=tmp_6;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  tmp=select(plist,indexof(#,"Invert")>0); //180929from
  if(length(tmp)>0,encflg=1,encflg=0);
  trim="N";
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(tmp_1);
    tmp2=Toupper(tmp_2);
    if(substring(tmp1,0,1)=="E",
      if(substring(tmp2,0,1)=="Y",
        encflg=1;
      );
      if(substring(tmp2,0,1)=="N",
        encflg=0;
      );
    );
    if(substring(tmp1,0,1)=="T",
      trim=substring(tmp2,0,1);
    );
  );
  startpt=[];
  forall(reL,
    if(islist(#),
      startpt=#;
    );
  ); //180929to
  if(length(color)==4, //180602from
    tmp=Colorcmyk2rgb(color);
  );
  flg=0; ctr=1;
  if(encflg==1, //180929from
    if(length(startpt)==2,
      Enclosing(nm,plist,[startpt,"nodisp"]);
    ,
      Enclosing(nm,plist,["nodisp"]);
    );
    plist=["en"+nm];
  ); //180929to
  if((length(plist)==1)&(trim=="Y"), //190220from,109224
    plist=[Shadein(plist)];
  ); //190220to
  forall(1..(length(plist)),jj, //180613from
    if(flg==0,
      tmp1=plist_jj;
      if(isstring(tmp1),tmp=parse(tmp1),tmp=tmp1);
      if(!islist(tmp),
         flg=1;
      ,
        if(!isstring(tmp1),
          tmp2=[];
          forall(tmp1,if(ispoint(#),tmp=#.xy,tmp=#);
            tmp2=append(tmp2,tmp);
          );
          Listplot("-"+name+text(ctr),tmp2,["nodisp"]); //190520
          plist_jj=name+text(ctr);
          ctr=ctr+1;
        );
      ); 
    );
  );//180613to
  if(flg==1,
    println("    some data not defined properly");
 ,
    G2=Joincrvs("1",plist,["nodata"]);
    G2=apply(G2,Pcrd(#));
    tmp1="fillpoly("+Textformat(G2,5)+opcindy+");";
    parse(tmp1);
  );
  SHADECTR=SHADECTR+1;
);
Enclosing(nm,plist):=Enclosing2(nm,plist,[]);//180706[2lines]
Enclosing(nm,plistorg,options):=Enclosing2(nm,plistorg,options);
Enclosing2(nm,plist):=Enclosing2(nm,plist,[]);
Enclosing2(nm,plistorg,options):=(
  regional(name,plist,AnsL,Start,Eps,Eps1,Eps2,flg,Fdata,Gdata,KL,
      t1,t2,tst,ss,ii,nn,nxtno,Ltype,Noflg,realL,eqL,opstr,opcindy,
      tmp,tmp1,tmp2,color,epspara,p1,p2);
  name="en"+nm;
  plist=plistorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  realL=tmp_6;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Eps=10^(-5); // 16.12.05
  epspara=1; //180707
  Eps1=0.01;
  Eps2=0.1;
  Start=[];
  flg=0;
  forall(realL,
    if(isList(#) % ispoint(#),
      Start=Lcrd(#); // 18.02.02
    ,
      if(flg==0,epspara=#);//180707
      if(flg==1,Eps1=#);
      if(flg==2,Eps2=#);
      flg=flg+1;
    );
  );
  flg=0;
  AnsL=[];
  if(length(plist)==1,
    Fdata=parse(plist_1);
    tmp1=Fdata_1;
    tmp2=Fdata_(length(Fdata));
    if(|tmp1-tmp2|<Eps,
      AnsL=Fdata;
    ,
      AnsL=append(Fdata,tmp1);
    );
    flg=1;
  );
  if(flg==0,
    Fdata=plist_1;
    Gdata=plist_(length(plist));
    KL=Intersectcurvespp(Fdata,Gdata);
    if(length(KL)==0,
      tmp=parse(Gdata);
      tmp1=LLcrd(Op(length(tmp),tmp)); //18.02.02from
      tmp=parse(Fdata);
      tmp2=LLcrd(Op(1,tmp));
      tmp=Listplot(name,[tmp1,tmp2],["nodisp"]);
      plist=append(plist,"sg"+name);
      Start=tmp2;
      tst=1; //18.02.02to
      p1=Start;
    ,
      if(length(KL)==1,
        tst=KL_1_2;
        Start=Pointoncurve(tst,Fdata);
      );
      if(length(KL)>1,
        KL=sort(KL,[#_2]);
        if(Start==[],
          tst=KL_1_2;
          Start=Pointoncurve(tst,Fdata);
        ,
          tmp=apply(KL,|#_1-Start|);
          tmp=min(tmp);
          tmp1=select(KL,|#_1-Start|<tmp+Eps1);//180718
          tst=tmp1_1_2;
          Start=Pointoncurve(tst,Fdata);
        );
      );
    );
  );
  if(flg==0,
    t1=tst;
    p1=Pointoncurve(t1,Fdata); //180713
    println("Start point of enclosing is "+text(Start));
    forall(1..(length(plist)),nn,
      Fdata=plist_nn;
      if(nn==length(plist),nxtno=1,nxtno=nn+1);
      Gdata=plist_nxtno;
      KL=Intersectcurvespp(Fdata,Gdata);
      if(length(KL)==0,
        tmp1=parse(Fdata); //18.02.02from
        tmp2=parse(Gdata); 
        tmp2=Prepend(Op(length(tmp1),tmp),tmp2);
        Gdata=replace(Gdata,"(","");
        Gdata=replace(Gdata,")","");
        tmp=Gdata+"="+Textformat(tmp2,6)+";"; //190415
        parse(tmp);
        plist_nxtno=Gdata;
        t2=Length(tmp1);
        p2=Pointoncurve(t2,Fdata); //180713
        ss=1; //18.02.02to
      ,
        KL=sort(KL,[#_2]);//180706
        tmp=parse(Fdata);
        tmp1=t1+epspara/50*length(tmp);
        KL=select(KL,(#_2>tmp1)%((#_2>t1)&(|#_1-p1|>Eps1))); //180713,16
        t2=KL_1_2;
        ss=KL_1_3;
        if(abs(t2-t1)<Eps,//180707
          if(length(KL)>1,
            t2=KL_2_2;
            ss=KL_2_3;
          ,
            println(text(nn)+" and "+text(nxtno)+" not intersect");
            flg=1;
          );
        );
      );
      if(flg==0,
        tmp=Partcrv("",t1,t2,Fdata,["nodata"]);
        if(nn==1,
          AnsL=tmp;
        ,
          AnsL=concat(AnsL,tmp_(2..(length(tmp))));
        );
      );
      t1=ss;//180706
      p1=Pointoncurve(t1,Gdata); //180713
    );
  );
  if(flg==0,
    AnsL=apply(AnsL,Pcrd(#));
  );
  if(Noflg<3,
    println("generate Enclosing "+name);
    tmp=name+"="+Textformat(AnsL,5)+";"; //190415
    parse(tmp);
    tmp=name+"=Enclosing2(";//16.11.07from
    tmp1="list"+PaO();
    forall(plistorg, //18.02.02
      tmp1=tmp1+#+",";
    );
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  tmp=apply(AnsL,LLcrd(#));//16.10.20
  tmp;
);
Listplot(list):=Listplot(list,[]);
Listplot(Arg1,Arg2):=(
  regional(name,list,options,str);
  if(isstring(Arg1),
    name=Arg1;
    list=Arg2;
    Listplot(name,list,[]);
  ,
    list=Arg1;
    options=Arg2;
    name="";
    forall(list, // 16.10.07from
       name=name+#.name;
    );// 16.10.07until
    Listplot(name,list,options);
  );
);
Listplot(nm,list,options):=(
  regional(name,cutend,tmp,tmp1,tmp2,ptlist,Ltype,opcindy,Noflg,eqL,Msg,color);
  if(substring(nm,0,1)=="-",  // 16.01.27 from
    name=substring(nm,1,length(nm));
  ,
    name="sg"+nm;
  ); // upto
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  Msg="Y";  //190206
  cutend=[0,0];//180719
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="M",
      Msg=Toupper(substring(tmp_2,0,1));
    );
    if(tmp1=="C",//180719from
      tmp2=replace(tmp_2,"[","");
      tmp2=replace(tmp2,"]","");
      cutend=tokenize(tmp2,",");
      if(length(cutend)==1,cutend=[cutend_1,cutend_1]);     
    );//180719to
  );
  if(Noflg<3,
    if(Msg=="Y", //190206
      println("generate Listplot "+name);
    );
    if(isstring(list_1),tmp=apply(list,parse(#)),tmp=list); // 15.03.24
    ptlist=apply(tmp,Pcrd(#));
    if(|cutend|>0,//180719from
      tmp=ptlist_(length(ptlist))-ptlist_1;
      tmp=tmp/|tmp|;
      ptlist_1=ptlist_1+tmp*cutend_1;
      ptlist_(length(ptlist))=ptlist_(length(ptlist))-tmp*cutend_2;
    );//180719to
    tmp=name+"="+Textformat(ptlist,5)+";"; //190415
    parse(tmp);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  tmp1=apply(list,Lcrd(#));
  tmp1;
);
Intersectcurvespp(crv1org,crv2org):=Intersectcurvespp(crv1org,crv2org,[]);
Intersectcurvespp(crv1org,crv2org,options):=(
  regional(Eps,Eps1,Eps2,Dist,crv1,crv2,ii,jj,seg1,seg2,self,loopL,out,
          flg,tmp,tmp1,tmp2);
  Eps=10^(-4);
  Eps1=0.01;
  Eps2=0.1;
  Dist=10*Eps2;
  if(length(options)>0,
    Eps1=options_1;
    if(length(options)>1,
      Eps2=options_2;
      Dist=10*Eps2;
      if(length(options)>2,
        Dist=options_3;
      );
    );
  );
  if(isstring(crv1org),tmp1=parse(crv1org),tmp1=crv1org);//18.01.05from
  if(isstring(crv2org),tmp2=parse(crv2org),tmp2=crv2org);
  tmp1=apply(tmp1,LLcrd(#));
  tmp2=apply(tmp2,LLcrd(#));
  crv1=[tmp1_1];
  forall(tmp1,
    tmp=crv1_(length(crv1));
    if(|tmp-#|>Eps,
      crv1=append(crv1,#);
    );
  );
  crv2=[tmp2_1];
  forall(tmp2,
    tmp=crv2_(length(crv2));
    if(|tmp-#|>Eps,
      crv2=append(crv2,#);
    );
  );//18.01.05until
  if(crv1==crv2,
    self=1;
  ,
    self=0;
  );
  out=[];
  forall(1..(length(crv1)-1),ii,
    if(self==0,
      loopL=1..(length(crv2)-1);
    ,
      loopL=(ii+2)..(length(crv2)-1);
    );
    forall(loopL,jj,
      tmp=Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2,Dist);
      if(length(tmp)>0,
        if(length(out)==0,
          out=[tmp];
        ,
          tmp1=out_(length(out));
          if(|tmp1_1-tmp_1|>Eps1,
            out=append(out,tmp);
          );
        );
        if(self==1,
          tmp=[tmp_1,tmp_3,tmp_2,tmp_4,tmp_5];
          out=append(out,tmp);
        );
      );
    );
  );
  tmp2=out;
  out=[];
  tmp1=tmp2;
  flg=0;
  forall(1..(length(tmp2)),
    if(flg==0,
      tmp=Collectsameseg(tmp1);
      out=append(out,tmp_1);
      if(length(tmp_2)==0,
        flg=1;
      ,
        tmp1=tmp_2;
      );
    );
  );
  forall(1..(length(out)),ii,
    tmp1=out_ii;
    if(length(tmp1)==1,
      out_ii=tmp1_1;
    ,
      tmp=apply(tmp1,#_4);
      dst=min(tmp);
      tmp1=select(tmp1,#_4<dst+Eps);
      tmp=apply(tmp1,#_1);
      tmp=sum(tmp)/length(tmp);
      tmp2=[tmp];
      tmp=Nearestpt(tmp2_1,crv1org);
      tmp2=append(tmp2,tmp_2);
      tmp=Nearestpt(tmp2_1,crv2org);
      tmp2=append(tmp2,tmp_2);
      tmp2=concat(tmp2,[dst,tmp1_1_5]);
      out_ii=tmp2;
    );
  );
  if(length(out)>0,  //190221from
    out=sort(out,[#_2]);
  );  //190221to
  out;
);
LLcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=pt.xy
  ,
    tmp=pt;
  );
  tmp=[tmp_1/SCALEX,tmp_2/SCALEY];
  tmp;
);
Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2):=(
  Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2,10*Eps2);
);
Intersectpartseg(crv1org,crv2org,ii,jj,Eps1,Eps2,Dist):=(
  regional(crv1,crv2,Eps,dst,kk,ll,seg1,seg2,snang,
     p0,p1,p2,p3,os1,os2,out,tmp,tmp1,tmp2,flg);
  crv1=crv1org; crv2=crv2org;
  if(isstring(crv1),crv1=parse(crv1));
  if(isstring(crv2),crv2=parse(crv2));
  Eps=10^(-4);
  out=[];
  seg1=[crv1_ii,crv1_(ii+1)];
  seg2=[crv2_jj,crv2_(jj+1)];
  tmp1=seg1_2-seg1_1;
  tmp2=seg2_2-seg2_1;
  snang=abs(Crossprod(tmp1,tmp2))/(Norm(tmp1)*Norm(tmp2));
  tmp=Intersectseg(seg1,seg2,Eps1);
  dst=tmp_1;
  if(dst<Eps,
    out=[tmp_2,ii+tmp_3,jj+tmp_4,dst,snang];
  ,
    if(dst<Eps2,
      if((length(crv1)==2)%(|seg1_2-seg1_1|>Dist-Eps),
        os1=seg1;
      ,
        p1=seg1_1; p2=seg1_2;
        if(ii==1,
          p3=crv1_3;
          tmp=p2-p1;
          tmp=(p1+p2)/2+[tmp_2,-tmp_1];
          p0=Reflectpoint(p3,[(p1+p2)/2,tmp]);
        ,
          if(ii==length(crv1)-1,
            p0=crv1_(ii-1);
            tmp=p2-p1;
            tmp=(p1+p2)/2+[tmp_2,-tmp_1];
            p3=Reflectpoint(p0,[(p1+p2)/2,tmp]);
          ,
            p0=crv1_(ii-1); p3=crv1_(ii+2);
          );
        );
        os1=Osplineseg([p0,p1,p2,p3]);
      );
      if((length(crv2)==2)%(|seg2_2-seg2_1|>Dist-Eps), //18.01.05
        os2=seg2;
      ,
        p1=seg2_1; p2=seg2_2;
        if(jj==1,
          p3=crv2_3;
          tmp=p2-p1;
          tmp=(p1+p2)/2+[tmp_2,-tmp_1];
          p0=Reflectpoint(p3,[(p1+p2)/2,tmp]);
        ,
          if(jj==length(crv2)-1,
            p0=crv2_(jj-1);
            tmp=p2-p1;
            tmp=(p1+p2)/2+[tmp_2,-tmp_1];
            p3=Reflectpoint(p0,[(p1+p2)/2,tmp]);
          ,
            p0=crv2_(jj-1); p3=crv2_(jj+2);
          );
        );
        os2=Osplineseg([p0,p1,p2,p3]);
      );
      tmp2=[];
      forall(1..(length(os1)-1),kk,
        forall(1..(length(os2)-1),ll,
          seg1=[os1_kk,os1_(kk+1)];
          seg2=[os2_ll,os2_(ll+1)];
          tmp=Intersectseg(seg1,seg2,Eps1);
          if((tmp_1<Eps1)&(length(tmp)>1), //18.02.06
            if(tmp_1<dst+Eps,
              dst=tmp_1;
              tmp2=select(tmp2,#_1<dst);
              tmp2=append(tmp2,[dst,tmp_2]);
            );
          );
        );
      );
      if(length(tmp2)>0,
        tmp=apply(tmp2,#_2_1);
        tmp1=[sum(tmp)/length(tmp2)];
        tmp=apply(tmp2,#_2_2);
        tmp1=append(tmp1,sum(tmp)/length(tmp2));
        out=[tmp1];
        p1=crv1_ii; p2=crv1_(ii+1);
        tmp=[Op(2,p2-p1),-Op(1,p2-p1)];
        tmp=Intersectline(out_1,tmp,p1,p2-p1);
        tmp=min([max([tmp_3,0]),1]);
        out=[tmp1,ii+tmp];
        p1=crv2_jj; p2=crv2_(jj+1);
        tmp=[Op(2,p2-p1),-Op(1,p2-p1)];
        tmp=Intersectline(out_1,tmp,p1,p2-p1);
        tmp=min([max([tmp_3,0]),1]);
        out=concat(out,[jj+tmp,dst,snang]);
      );
    );
  );
  out;
);
Crossprod(a,b):=(
  regional(tmp1,tmp2,tmp3,Out);
  if(length(a)==3,
    tmp1=a_2*b_3-a_3*b_2;
    tmp2=a_3*b_1-a_1*b_3;
    tmp3=a_1*b_2-a_2*b_1;
    Out=[tmp1,tmp2,tmp3];
  ,
    Out=a_1*b_2-a_2*b_1;
  );
  Out;
);
Norm(v1):=(  // 16.09.01
  regional(out,tmp,tmp1,tmp2);
  out=0;
  forall(1..(length(v1)),
    out=out+(v1_#)^2;
  );
  out=sqrt(out);
  out;
);
Norm(v1,v2):=(
  Norm(v2-v1);
);
Reflectpoint(point,symL):=(
  regional(X1,X2,Y1,Y2,Us,Vs,Pt1,Pt2,Cx,Cy,tmp);
  tmp=Lcrd(point);
  X1=tmp_1; Y1=tmp_2;
  Pt1=Lcrd(symL_1);
  if(length(symL)==1,
    Pt2=Pt1;
  ,
    Pt2=Lcrd(symL_2);
  );
  Us=Pt2_1-Pt1_1;
  Vs=Pt2_2-Pt1_2;
  if(Pt1==Pt2,
    X2=2*Pt1_1-X1;
    Y2=2*Pt1_2-Y1;
  ,
    X2=(Us^2-Vs^2)/(Us^2+Vs^2)*X1+2*Us*Vs/(Us^2+Vs^2)*Y1
              -2*Vs*(Us*Pt1_2-Vs*Pt1_1)/(Us^2+Vs^2);
    Y2=2*Us*Vs/(Us^2+Vs^2)*X1-(Us^2-Vs^2)/(Us^2+Vs^2)*Y1
              +2*Us*(Us*Pt1_2-Vs*Pt1_1)/(Us^2+Vs^2);
  );
  [X2,Y2];
);
Osplineseg(list):=Osplineseg(list,[]);
Osplineseg(ptlist,optionsorg):=(
  regional(tmp,tmp1,tmp2,list,ptL,ctrL,Eps,Eps0,
      p0,p1,p2,p3,pQ,pR,cc,p01,p02,p11,p12,p21,p22,p31,p32,out);
  Eps=10^(-2);
  Eps0=10^(-6);
  if(isstring(ptlist),list=parse(ptlist),list=ptlist);
  p0=list_1; p1=list_2; p2=list_3; p3=list_4;
  tmp=1+sqrt((1+Dotprod(p2-p0,p3-p1)/|p2-p0|/|p3-p1|)/2);
  cc=4*|p2-p1|/3/(|p2-p0|+|p3-p1|)/tmp;
  pQ=p1+cc*(p2-p0); // 15.09.21  // 16.08.16
  pR=p2+cc*(p1-p3);  // 16.08.16
  ctrL=[pQ,pR];
  options=optionorg;
  options=concat(options,["Num=20","nodata"]);
  out=Bezier("",[p1,p2],ctrL,options);
  out;
);
Dotprod(vec1,vec2):=(
  regional(v1,v2,tmp);
  if(ispoint(vec1),v1=vec1.xy,v1=vec1);
  if(ispoint(vec2),v2=vec2.xy,v2=vec2);
  v1*v2;
);
Bezier(ptctrlist):=Beziercurve(ptctrlist_3,ptctrlist_1,ptctrlist_2,[]);
Bezier(Arg1,Arg2):=( //190202from
  regional(nm,ptctrlist,options);
  if(islist(Arg1),
    ptctrlist=Arg1; options=Arg2;
    Beziercurve(ptctrlist_3,ptctrlist_1,ptctrlist_2,options);
  ,
    nm=Arg1; ptctrlist=Arg2;
    Beziercurve(nm,ptctrlist_1,ptctrlist_2,[]);
  );
); //190202to
Bezier(nm,ptlist,ctrlist):=Beziercurve(nm,ptlist,ctrlist,[]);
Bezier(nm,ptlist,ctrlist,options):=Beziercurve(nm,ptlist,ctrlist,options);
Beziercurve(nm,ptlist,ctrlist):=Beziercurve(nm,ptlist,ctrlist,[]);
Beziercurve(nm,ptlistorg,ctrlistorg,options):=(
  regional(name,Ltype,Noflg,opstr,opcindy,Num,
    ptlist,ctrlist,tmp,tmp1,tmp2,ii,st,out,list,color);
  name="bz"+nm;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Num=10;
  tmp1=tmp_5;
  forall(tmp1,     // 14.12.31
    if(substring(#,0,1)=="N",
      tmp2=indexof(#,"=");
      Num=parse(substring(#,tmp2,length(#)));
      opstr=opstr+","+Dq+#+Dq;
    );
  );
  ptlist=apply(ptlistorg,Lcrd(#)); // 16.08.16
  ctrlist=[];  // 14.12.31
  if(length(ctrlistorg)==length(ptlist)-1,
    forall(1..(length(ctrlistorg)),ii, //190202
      tmp1=apply(ctrlistorg_ii,Lcrd(#));  //190202
      if(Measuredepth(tmp1)==0,tmp=[tmp1],tmp=tmp1);
      ctrlist=append(ctrlist,tmp);
    );
  ,
    forall(1..(length(ptlist)-1),ii,
      tmp=ctrlistorg_((2*ii-1)..(2*ii));
      tmp=apply(tmp,Lcrd(#)); // 16.08.16
      ctrlist=append(ctrlist,tmp);
    );
  );
  if(!islist(Num),
    Num=apply(ctrlist,Num);
  );
  list=[];
  forall(1..(length(ptlist)-1),ii,
    tmp1=ptlist_(ii..(ii+1));
    tmp2=ctrlist_ii;
    if(ii==1,st=0,st=1);
    forall(st..Num_ii,
      tmp=Bezierpt(#/Num_ii,tmp1,tmp2);
      list=append(list,tmp);
    );
  );
  if(Noflg<3,
    println("generate Bezier "+name);
    out=apply(list,Pcrd(#));
    tmp=name+"="+Textformat(out,5)+";"; //190415
    parse(tmp);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  BezierCtrL=ctrlist; //181001
  list;
);
Bezierpt(t,ptlist,ctrlist):=(
  regional(flg3,p0,p1,p2,p3,p4,p5,p6,p7,p8,p9);
  p0=ptlist_1;
  p3=ptlist_2;
  p1=ctrlist_1;
  if(length(ctrlist)==1,
    p2=p3;
    flg3=0;
  ,
    p2=ctrlist_2;
    flg3=1;
  );
  if(length(p0)<3,  // 15.02.08
    p0=Lcrd(p0);
    p3=Lcrd(p3);
    p1=Lcrd(p1);
    p2=Lcrd(p2);
  );
  p4=(1-t)*p0+t*p1;
  p5=(1-t)*p1+t*p2;
  p6=(1-t)*p2+t*p3;
  p7=(1-t)*p4+t*p5;
  p8=(1-t)*p5+t*p6;
  p9=(1-t)*p7+t*p8;
  if(flg3==0,p7,p9);
);
Intersectseg(seg1,seg2):=Intersectseg(seg1,seg2,0.01);
Intersectseg(seg1org,seg2org,Eps1):=(
  regional(Eps,seg1,seg2,p1,p2,q1,q2,t,s,pt,n,pts,out,dist,
    tmp,tmp1,tmp2,tmp3);
  Eps=10^(-4);
  seg1=seg1org;
  seg2=seg2org;
  if(isstring(seg1),seg1=parse(seg1));
  if(isstring(seg2),seg2=parse(seg2));
  out=[];
  p1=seg1_1; q1=seg1_2;
  p2=seg2_1; q2=seg2_2;
  if((|q1-p1|<Eps)%(|q2-p2|<Eps),
    out=[-1];
  ,
    tmp=Intersectline(p1,q1-p1,p2,q2-p2);
    if(islist(tmp_1),
      pt=tmp_1; t=tmp_2; s=tmp_3;
      if((t*(t-1)<Eps)&(s*(s-1)<Eps),
        out=[0,pt,t,s];
      ,
        t=min([max([t,0]),1]);
        s=min([max([s,0]),1]);
        tmp3=[|p1-p2|,|p1-q2|,|q1-p2|,|q1-q2|]; //18.01.30from
        tmp1=[Op(2,q2-p2),-Op(1,q2-p2)];
        tmp=Intersectline(p1,tmp1,p2,q2-p2);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-p1|);
          );
        );
        tmp=Intersectline(q1,tmp1,p2,q2-p2);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-q1|);
          );
        );
        tmp1=[Op(2,q1-p1),-Op(1,q1-p1)];
        tmp=Intersectline(p2,tmp1,p1,q1-p1);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-p2|);
          );
        );
        tmp=Intersectline(q2,tmp1,p1,q1-p1);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-q2|);
          );
        );
        out=[min(tmp3),pt,t,s]; //18.01.30until
      );
    ,
      dist=tmp_1;
      tmp1=q1-p1;      
      n=[tmp1_2,-tmp1_1]/|tmp1|;
      pts=[];
      tmp=Intersectline(p1,n,p2,q2-p2);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p2+tmp_3*q2;
        pts=append(pts,[tmp1,0,tmp_3]);
      );
      tmp=Intersectline(q1,n,p2,q2-p2);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p2+tmp_3*q2;
        pts=append(pts,[tmp1,1,tmp_3]);
      );
      tmp=Intersectline(p2,n,p1,q1-p1);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p1+tmp_3*q1;
        pts=append(pts,[tmp1,tmp_3,0]);
      );
      tmp=Intersectline(q2,n,p1,q1-p1);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p1+tmp_3*q1;
        pts=append(pts,[tmp1,tmp_3,2]);
      );
      if(length(pts)==0,
        tmp1=min([|p2-p1|,|q2-p1|,|p2-q1|,|q2-q1|]);
        out=[tmp1];
      ,
        if(dist>Eps1,
          out=[dist];
        ,
          tmp=apply(pts,#_1_1);
          tmp1=sum(tmp)/(length(pts));
          tmp=apply(pts,#_1_2);
          tmp2=sum(tmp)/(length(pts));
          tmp3=[tmp1,tmp2];
          tmp=Nearestpt(tmp3,seg1);
          tmp1=tmp_2;
          tmp=Nearestpt(tmp3,seg2);
          tmp2=tmp_2;
          out=[dist,tmp3,tmp1,tmp2];
        );
      );
    );
  );
  out;
);
Op(n,object):=( //  16.05.25
  regional(out);
  if(islist(object),
    out=object_n;
  ,
    if(isstring(object),
      out=substring(object,n-1,n);
    );
  );
  out;
);
Intersectline(p1,v1,p2,v2):=(
  regional(Eps,d,dt,ds,t,s,pt,out,tmp,tmp1,tmp2,tmp3);
  Eps=10^(-5);
  out=[];
  tmp=Dotprod(v1,v2);
  tmp1=[tmp,|v1|^2];
  tmp2=[-|v2|^2,-tmp];
  tmp3=[Dotprod(p2-p1,v2),Dotprod(p2-p1,v1)];
  d=Crossprod(tmp1,tmp2);
  tmp=abs(Crossprod(v1,v2));
  if(tmp>Eps,
    dt=Crossprod(tmp3,tmp2);
    ds=Crossprod(tmp1,tmp3);
    t=dt/d;
    s=ds/d;
    pt=p1+v1*t;
    out=[pt,t,s];
  ,
    tmp1=Crossprod(p2-p1,v1)/|v1|; //18.01.05
    out=[abs(tmp1)]; //18.01.05
  );
  out;
);
Nearestpt(point,PL2):=(
  regional(PL1,PL,Ans,Flg,Eps,pA,Pm,Im,Sm,Nn,Ni,
      a1,b1,a2,b2,v1,v2,x1,x2,Tmp,rT,pP,sS,Lm,Pm,Sm,Flg);
  if(isstring(point),PL1=parse(point),PL1=point);
  if(Measuredepth(PL1)==2,PL1=PL1_1);
  if(!islist(PL1_1),
    PL1=[PL1];
    Flg=0;
  ,
    Flg=1;
  );
  if(isstring(PL2),PL=parse(PL2),PL=PL2);
  if(Measuredepth(PL)==2,PL=PL_1);
  Eps=10^(-6);
  Ans=[PL1_1,1,PL_1,1,|PL1_1-PL_1|];
  forall(1..(length(PL1)),Nn, // 16.05.04
    pA=PL1_Nn;
    Pm=PL_1;
    Im=1;
    Sm=|Pm-pA|;
    forall(1..(length(PL)-1),Ni,
      a1=PL_Ni_1; a2=PL_Ni_2;
      b1=PL_(Ni+1)_1; b2=PL_(Ni+1)_2;
      v1=b1-a1; v2=b2-a2;
      x1=pA_1; x2=pA_2;
      Tmp=v2^2+v1^2;
      if(abs(Tmp)>Eps,
        rT=(-a2*v2-v1*a1+v1*x1+x2*v2)/Tmp;
        if(rT<-Eps,
          pP=[a1,a2];
        ,
          if(rT>1+Eps,
            pP=[b1,b2];
          ,
            pP=[a1+rT*v1,a2+rT*v2];
          );
        );
        sS=|pP-pA|;
        if(sS<Sm-Eps,
          Tmp=Paramoncurve(pP,Ni,PL);
          Pm=pP; Lm=Tmp; Sm=sS;
        );
      );
      if(Sm<Ans_5,  // 16.05.03from
        Ans=[pA,Nn,Pm,Lm,Sm];
      );
    );  // 16.05.03until
  );
  if(Flg==0,
    Ans=Ans_(3..5);
  );
  Ans;
);
Paramoncurve(point,Gdata):=(
  regional(Tmp,PtL,pP);
  if(ispoint(point),pP=point.xy,pP=point);
  if(isstring(Gdata),PtL=parse(Gdata),PtL=Gdata);
  Tmp=Nearestpt(pP,PtL);
  Tmp_2;
);
Paramoncurve(pP,nN,plist):=(
  regional(PtL,Out,Pa,Pb,vV,vW,sS);
  if(isstring(plist),PtL=parse(plist),PtL=plist);
  PtL=apply(PtL,LLcrd(#));//16.10.16
  if(nN==length(PtL),
    Out=nN;
  ,
    Pa=PtL_nN;
    Pb=PtL_(nN+1);
    vV=Pb-Pa;
    vW=pP-Pa;
    sS=vV*vW/|vV|^2;
    sS=min([max([sS,0]),1]);
    Out=nN+sS;
  );
  Out;
);
Collectsameseg(ptdL):=(
  regional(Eps,gL,rL,numL,ii,jj,flg,tmp,tmp1,tmp2,tmp1md,
       dst,kk,s1,e1,s2,e2);
  Eps00=10^(-8);
  if(length(ptdL)==0,
    gL=[];rL=[];
  ,
    tmp1md=[ptdL_1];
    rL=ptdL_(2..(length(ptdL)));
    tmp1=tmp1md_1;
    kk=floor(tmp1_2);
    if(tmp1_2<kk+Eps00,
      s1=kk-1-Eps00; e1=s1+2+2*Eps00;
    ,
      s1=kk-Eps00; e1=s1+1+2*Eps00;
    );
    kk=floor(tmp1_3);
    if(tmp1_3<kk+Eps00,
      s2=kk-1-Eps00; e2=s2+2+2*Eps00;
    ,
      s2=kk-Eps00; e2=s2+1+2*Eps00;
    );
    numL=[];
    forall(1..(length(rL)),ii,
      tmp=rL_ii;
      tmp1=tmp_2;tmp2=tmp_3;
      if((tmp1>s1)&(tmp1<e1)&(tmp2>s2)&(tmp2<e2),
        tmp1md=append(tmp1md,tmp);
        numL=append(numL,ii);
      );
    );
    gL=[];
    tmp=apply(tmp1md,#_4);
    dst=min(tmp);
    forall(tmp1md,
      if(#_4<dst+Eps00,
        gL=append(gL,#);
      );
    ); 
    rL=remove(rL,rL_(numL));
  );
  [gL,rL];
);
Partcrv(nm,pA,pB,PkLstr):=Partcrv(nm,pA,pB,PkLstr,[]);
Partcrv(nm,pA,pB,PkLstr,options):=(
  regional(PkL,Ans,Eps,Npt,Out1,Out2,tmp,tmp1,Flg,nS,nE,PPL,pP,
        opcindy,Ta,Tb,name,Ltype,Noflg,DepthFlg,color);
  name="part"+nm;
  if(isstring(PkLstr),PkL=parse(PkLstr),PkL=PkLstr);
  DepthFlg=0;
  if(Measuredepth(PkL)==2,
    PkL=PkL_1;
    DepthFlg=1;
  );
  PkL=apply(PkL,LLcrd(#));
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  Eps=10^(-3);
  Flg=0;
  if(isreal(pA),
    if(pA>pB+Eps,
      Npt=Numptcrv(PkL);
      Out1=Partcrv("",pA,Npt,PkLstr,["nodata"]);
      Out2=Partcrv("",1,pB,PkLstr,["nodata"]);
      tmp=Ptstart(PkL)-Ptend(PkL);
      if(|tmp|<Eps,
        Ans=Joincrvs("",[Out1,Out2],["nodata"]);
      ,
        Ans=[apply(Out1,Pcrd(#)),apply(Out2,Pcrd(#))];
      );
      Flg=1;
    );
    if(Flg==0,
      nS=ceil(pA);
      nE=floor(pB);
      PPL=[];
      if(pA<nS-Eps,
        pP=(nS-pA)*PkL_(nS-1)+(1-nS+pA)*PkL_nS;
        PPL=[pP];
      );
      PPL=concat(PPL,PkL_(nS..nE));
      if(pB>nE+Eps,
        pP=(1-pB+nE)*PkL_nE+(pB-nE)*PkL_(nE+1);
        PPL=concat(PPL,[pP]);
      );
      Ans=PPL;
      Flg=1;
    );
  );
  if(Flg==0,
    tmp=Nearestpt(LLcrd(Pcrd(pA)),PkL);
    Ta=tmp_2;
    tmp=Nearestpt(LLcrd(Pcrd(pB)),PkL); // 15.09.12
    Tb=tmp_2;
    Ans=Partcrv("",Ta,Tb,PkL,["nodata"] );
    Ans=apply(Ans,Pcrd(#));
  );
  if(Noflg<3,
    println("generate partcrv "+name);
    tmp1=apply(Ans,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,5)+";"; //190415
    parse(tmp);
    if(DepthFlg==0,
      tmp=PkLstr;
    ,
      tmp=PkLstr+"(1)";
    );
    tmp1=name+"=Partcrv("+Textformat(Lcrd(pA),5)
         +","+Textformat(Lcrd(pB),5)+","+tmp+")"; // 16.04.03
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  Ans;
);
Numptcrv(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);  // 15.12.23
  length(tmp);
);
Ptstart(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);  // 16.01.21
  tmp_1;
);
Ptend(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);
  tmp_(length(tmp)); // 15.04.12
);
Joincrvs(nm,plotstrL):=Joincrvs(nm,plotstrL,[]);
Joincrvs(nm,plotstrL,options):=(
  regional(plotlist,PtL,Eps,QdL,Flg,Ni,Qd,pP,pS,pQ,pR,rMN,
        opcindy,tmp,tmp1,tmp2,str,name,Ltype,Noflg,color);
  name="join"+nm;
  plotlist=[];
  forall(plotstrL,str,
    if(isstring(str),
      tmp=parse(str);
      tmp=apply(tmp,LLcrd(#));
    ,
      tmp=str;
    );
    plotlist=append(plotlist,tmp);
  );
  Eps=10^(-4);
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  tmp1=tmp_6;
  if(length(tmp1)>0,Eps=tmp1_1);
  QdL=[];
  forall(plotlist,Qd,
    if(ispoint(Qd_1) % !islist(Qd_1_1),
      QdL=concat(QdL,[Qd]);
    ,
      forall(Qd,
        QdL=concat(QdL,[#]);
      );
    );
  );
  Flg=0;
  if(length(QdL)==0,
    PtL=[];
    Flg=1;
  );
  if(Flg==0,
    PtL=QdL_1;
    forall(2..(length(QdL)),Ni,
      Qd=QdL_Ni;
      if(Numptcrv(Qd)>1,
        pP=Ptend(PtL);
        pS=Ptstart(PtL);
        pQ=Ptstart(Qd);
        pR=Ptend(Qd);
        rMN=min([|pP-pQ|,|pP-pR|,|pS-pQ|,|pS-pR|]);
        if(rMN==|pP-pR|,
          Qd=reverse(Qd);
        ,
          if(rMN==|pS-pQ|,
            PtL=reverse(PtL);
          ,
            if(rMN==|pS-pR|,
              PtL=reverse(PtL);
              Qd=reverse(Qd);
            );
          );
        );
      );
      if(rMN>Eps,
        PtL=concat(PtL,Qd);
      ,
        PtL=concat(PtL,Qd_(2..(length(Qd))));
      );
    );
  );
  if(Noflg<3,
    println("generate joincurve "+name);
    tmp1=apply(PtL,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,5)+";";
    parse(tmp);
    tmp1="";
    forall(plotstrL,
        tmp1=tmp1+#+",";
    );
    tmp1=substring(tmp1,0,length(tmp1)-1);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  PtL;
);
Pointoncurve(tTorg,Gdata):=(
  regional(tT,Out,Eps,nN,sS,Pa,Pb,PtL);
  if(isstring(Gdata),PtL=parse(Gdata),PtL=Gdata);
  if(length(PtL)==1,PtL=PtL_1);
  tT=max([tTorg,1]); //18.01.04
  tT=min([tT,length(PtL)]); //18.01.04
  Eps=10^(-5); //18.01.04
  nN=floor(tT+Eps);
  sS=max([tT-nN,0]);
  if(nN==length(PtL),
    Out=PtL_nN;
  ,
    Pa=PtL_nN;
    Pb=PtL_(nN+1);
    Out=(1-sS)*Pa+sS*Pb;
  );
  Out;
);
Shadein(pstrorg):=( //190220
  regional(pstr,ptL,pL,crv,nn,
      tmp,tmp1,tmp2,pm1,pm2,p1,p2,flg);
  if(islist(pstrorg),pstr=pstrorg_1,pstr=pstrorg);
  crv=[];
  Framedata(["nodisp"]);
  ptL=Intersectcurvespp(pstr,frwin);
  if(length(ptL)>0,
    pL=apply(ptL,#_2);
    forall(1..(length(pL)),nn,
      if(nn<length(pL),
       tmp1=pL_nn;
       tmp2=pL_(nn+1);
       tmp=Pointoncrv((tmp1+tmp2)/2,pstr);
      ,
        tmp1=pL_nn;
        tmp2=pL_1;
        tmp=parse(pstr);
        if(pL_nn==length(tmp),
          tmp=tmp_1;
        ,
          tmp=tmp_(length(tmp));
        );
      );
      if(Inwindow(tmp),
        tmp=Partcrv("",tmp1,tmp2,pstr,["nodata"]);
      ,
        tmp1=Pointoncrv(tmp1,pstr);
        tmp2=Pointoncrv(tmp2,pstr);
        pm1=Paramoncrv(tmp1,frwin);
        pm2=Paramoncrv(tmp2,frwin);
        if(floor(pm1)==floor(pm2),
          tmp=Listplot("",[tmp1,tmp2],["nodata"]);
        ,
          tmp=floor(pm1);
          p1=Pointoncrv(tmp,"frwin");
          p2=Pointoncrv(mod(tmp,4)+1,"frwin");
          tmp=p1-10*(p2-p1);
          Listplot("frwin",[p1,tmp],["nodisp","Msg=n"]);
          tmp=Intersectcurvespp("sgfrwin",pstr);
          if(mod(length(tmp),2)==0, //190223from
            if(pm2<pm1,pm2=pm2+4); 
            tmp=[tmp1];
            pm1=floor(pm1)+1;
            flg=0;
            forall(1..3,
              if(flg==0,
                if(pm1<pm2,
                  p1=Pointoncrv(mod(pm1-1,4)+1,"frwin");
                  tmp=append(tmp,p1);
                  pm1=pm1+1;
                ,
                  flg=1;
                );
              );
            );
            if(pm1-1<pm2,tmp=append(tmp,tmp2));
          ,
            if(pm2>pm1,pm2=pm2-4);
            tmp=[tmp1];
            pm1=floor(pm1);
            flg=0;
            forall(1..3,
              if(flg==0,
                if(pm1>pm2,
                  p1=Pointoncrv(mod(pm1-1,4)+1,"frwin");
                  tmp=append(tmp,p1);
                  pm1=pm1-1;
                ,
                  flg=1;
                );
              );
            );
            if(pm1+1>pm2,tmp=append(tmp,tmp2));
          ); //190223to
        );
      );
      if(length(crv)==0,
        crv=tmp;
      ,
        crv=Joincrvs("",[crv,tmp],["nodata"]);
      );
    );
  ,
    if(Inwindow(parse(pstr+"_1")),crv=pstr,crv=frwin);
  );
  crv;
);
Framedata():=Framedata(["dr"]);//16.10.29from
Framedata(list):=(
  regional(pA,pB);
  if(Measuredepth(list)==0,
    pA=LLcrd((SW+NE)/2); // 15.09.17
    pB=LLcrd(NE);
    Framedata("win",[pA,pB],list);
  ,
    Framedata(list,[]);
  );
);//16.10.29until
Framedata(Arg1,Arg2):=(
  regional(name,list,options,str);
  if(isstring(Arg1),
    name=Arg1;
    list=Arg2;
    Framedata(name,list,[]);
  ,
    list=Arg1;
    options=Arg2;
    name="";// 16.10.07from
    forall(list, 
       name=name+#.name;
    );// 16.10.07until
    Framedata(name,list,options);
  );
);
Framedata(nm,list,optionsorg):=( //190424modified
  regional(name,options,Out,tmp,tmp1,x1,x2,y1,y2,dx,dy,
      opcindy,Ltype,Noflg,strL,cent,dx,dy,color);
  name="fr"+nm;
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  if(length(list)==2,  // 15.05.12
    cent=Lcrd(list_1); tmp=Lcrd(list_2);
    dx=abs(tmp_1-cent_1); dy=abs(tmp_2-cent_2);
  ,
    cent=Lcrd(list_1);
    dx=list_2; dy=list_3;
  );
  x1=cent_1-dx; x2=cent_1+dx;
  y1=cent_2-dy; y2=cent_2+dy;
  Listplot("-"+name,[[x1,y1],[x2,y1],[x2,y2],[x1,y2],[x1,y1]],options);
);
Framedata(nm,cent,dx,dy):=Framedata(nm,[cent,dx,dy],[]);
Framedata(nm,cent,dx,dy,options):=Framedata(nm,[cent,dx,dy],options);
Paramoncrv(pP,Gdata):=Paramoncurve(pP,Gdata);//180723
Pointoncrv(tT,PtL):=Pointoncurve(tT,PtL);
Inwindow(point):=Inwindow(point,[XMIN,XMAX],[YMIN,YMAX]);
Inwindow(point,xrng,yrng):=(
  regional(Eps,pt,x,y,xmin,xmax,ymin,ymax,tmp);
  Eps=10.0^(-6);
  if(ispoint(point),pt=point.xy,pt=point);
  x=pt_1; y=pt_2;
  xmin=xrng_1; xmax=xrng_2;
  ymin=yrng_1; ymax=yrng_2;
  tmp=(x>xmin-Eps)&(x<xmax+Eps)&(y>ymin-Eps)&(y<ymax+Eps);
  if(tmp,true,false);
);
Dqq(str):=DqDq(str); //18.02.11
DqDq(str):=(
  unicode("0022")+str+unicode("0022");
);
Expr(Pt,Dr,St):=Expr([Pt,Dr,St]);
Expr(list):=Expr(list,[]);
Expr(Pt,Dr,St,options):=Expr([Pt,Dr,St],options); //190409
Expr(listorg,options):=( //16.10.09
  regional(list,str,tmp,tmp1,tmp2);
  list=listorg;
  forall(1..round(length(list)/3),
    str=list_(3*#);
    if(!isstring(str),str=format(str,5));
    str="$"+str+"$";
    list_(3*#)=str;
  );
  Letter(list,options);
);
Letter(Pt,Dr,St):=Letter([Pt,Dr,St]);
Letter(list):=Letter(list,[]);
Letter(Pt,Dr,St,options):=Letter([Pt,Dr,St],options);//181218
Letter(list,options):=(
  regional(Nj,Pos,Dir,Str,Off,Dmv,Xmv,Ymv,Noflg,opcindy,
      opL,aln,sz,clr,bld,ita,tmp,tmp1,tmp2,color,eqL);
  tmp=Divoptions(options);
  eqL=tmp_5; //190209
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  opL=select(options,indexof(#,"->")>0); //16.10.09from
  tmp=select(opL,indexof(#,"color"));
  sz=12;
  bld=false;
  ita=false;
  aln="left";
  forall(opL,
    tmp=indexof(#,"->");
    tmp1=Removespace(substring(#,0,tmp-1));
    tmp2=substring(#,tmp+1,length(#));
    if(tmp1=="size",sz=parse(tmp2));
    if(tmp1=="color",clr=parse(tmp2));
    if(tmp1=="bold",bld=parse(tmp2));
    if(tmp1=="ita",ita=parse(tmp2));
  );//16.10.09to
  forall(eqL, //190209from
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="S",
      sz=round(parse(tmp_2)*12);
    );
  ); //190209to
  Off=-4;
  Dmv=8;
  Nj=1;
  if(Ketcindyjsfigure>0,sz=round(sz*Ketcindyjsscale) ); // 
  while(Nj+2<=length(list),
    Pos=list_Nj;
    Dir=list_(Nj+1);
    tmp=indexof(Dir,"s")+indexof(Dir,"n");//16.10.19from
    if(tmp>0, 
      tmp=indexof(Dir,"w")+indexof(Dir,"e");
      if(tmp==0,
        Dir="c"+Dir;//16.10.08
      );
    );//16.10.19until
    Str=list_(Nj+2);
    if(!isstring(Str),Str=format(Str,5)); // 16.09.30,10.09
    tmp=replace(Str,".xy","");
    tmp=replace(tmp,".x","(1)");
    Str=replace(tmp,".y","(2)");
    Str=RSslash(Str); // 17.09.24
    Str=replace(Str,"`","'");//180303
    tmp=Dq+","+Dq+Str+Dq+")";
    if(Noflg<2,
      Xmv=0;//16.10.13
      Ymv=-4;
      if(indexof(Dir,"n")>0,
        Ymv=Dmv/2;
      );
      if(indexof(Dir,"s")>0,
        Ymv=-Dmv*3/2;//16.10.13
      );
      if(indexof(Dir,"e")>0,
        Xmv=Dmv/2;
        Off=0;
        aln="left"; 
      );
      if(indexof(Dir,"w")>0, 
        Xmv=-Dmv/2;
        Off=0; // 16.09.30from
        aln="right"; 
      );
      if(indexof(Dir,"c")>0,
        Xmv=0;//16.10.13
        Off=0;
        if(Ymv==0,Ymv=-4);//16.10.08
        aln="mid"; // 16.09.30until
      );
      if(Ketcindyjsfigure>0, // 
        Off=round(Off*Ketcindyjsscale);
        Xmv=round(Xmv*Ketcindyjsscale);
        Ymv=round(Ymv*Ketcindyjsscale);
      ); // 
      Str=list_(Nj+2);  //17.10.17
      drawtext(Pcrd(Pos),Str,offset->[Off+Xmv,Off+Ymv],
         size->sz,color->color,align->aln,bold->bld,italics->ita);//16.10.09
    );
    Nj=Nj+3;
  );
);
Removespace(str):=(
  regional(tmp,flg,out);
  tmp=length(str)+1;
  flg=0;
  forall(1..(length(str)),
    if(flg==0,
      if((str_#)!=" ",
        tmp=#;
        flg=1;
      );
    );
  );
  out=substring(str,tmp-1,length(str));
  flg=0;
  tmp=0;
  forall(reverse(1..(length(out))),
    if(flg==0,
      if((out_#)!=" ",
        tmp=#;
        flg=1;
      );
    );
  );
  out=substring(out,0,tmp);
);
Sprintf(value,dig):=(
  regional(vv,tmp,tmp1);
  if(!islist(value),  // 17.03.12from
    if(isstring(value),
      vv=value;
    ,
      vv=Textformat(value,dig);
    );  // 17.03.12from
    if(indexof(vv,".")==0,vv=vv+".");
    vv=vv+"0000000000000000";
    tmp=indexof(vv,".")+dig;
    vv=substring(vv,0,tmp);
  ,
    vv=apply(value,Sprintf(#,dig));
  );
  vv;
);
Animationparam(start,ratio,stop):=( //190524
  regional(rng);
  if(islist(stop),rng=stop,rng=[start,stop]);
  if(isreal(Animeflg),
    if(Animeflg==1,
      sstart=Dirflg*ratio*seconds()+sorg;
    );
  ,
    Current=start;
    sstart=start;
  );
  if((sstart<=rng_1)%(sstart>=rng_2), //190528
    if(sstart<=rng_1,sstart=rng_1, sstart=rng_2); //190528
    stopanimation();
  );
  sstart;
);
Windispg():=(
  if(ADDAXES=="1", //181215from
    Drwxy();
    ADDAXES="0";
  ); //181215to
  Windispg(GCLIST); //190125
);
Windispg(gcLorg):=( //190125
  regional(gcL,Nj,Nk,Dt,Vj,tmp,tmp1,tmp2,tmp3,tmp4,opcindy);
  gcL=gcLorg; //190125from
  if(length(gcL)>0,
    if(!islist(gcL_1),gcL=[gcL]);
  ); //190125to
  gsave();
  layer(KETPIClayer);
  forall(gcL,Nj,
    if(isstring(Nj_1),Dt=parse(Nj_1),Dt=Nj_1);  // 11.17
    if(islist(Dt) & length(Dt)>0,  // 12.19,12.22
      tmp=Measuredepth(Dt);
      if(tmp==1,Dt=[Dt]);
      opcindy=Nj_3;
      tmp=Nj_2; //190119from
      if(!islist(tmp),tmp=[tmp,""]); //190123
      if(tmp_1<0,tmp1=0,tmp1=tmp_1); //190119from
      if(tmp1<10,
        forall(Dt,Nk,
          if(length(Nk)>1,
            tmp3="";
            if(indexof(opcindy,"color")==0, //190122from
              tmp3=tmp3+",linecolor->"+KCOLOR;
            );
            tmp3=tmp3+opcindy; 
            if(tmp1==0,  //190126from
              if((length(tmp_2)>0)&(indexof(opcindy,"size")==0), 
                tmp3=tmp3+",size->"+tmp_2;
              ); //190124to
              tmp="connect("+Textformat(Nk,5)+tmp3+");";//190125
              parse(tmp);
            ,
              if(tmp1==1,
                tmp=tokenize(Nj_2_2,",");tmp4=Dashlinedata(Nk,tmp_1,tmp_2,0); //190512
                forall(tmp4,
                  tmp="connect("+Textformat(#,5)+tmp3+");";
                  parse(tmp);
                );
              ,
                tmp3=",dashtype->"+text(tmp1)+tmp3;
                forall(1..(length(Nk)-1),
                  tmp="draw("+Textformat([Nk_#,Nk_(#+1)],5)+tmp3+");";
                  parse(tmp);
                );
              );
            );
          ,
            if(indexof(opcindy,"size")==0,  //190425from
              opcindy=opcindy+",size->"+text(TenSize/TenSizeInit);
            ); //190425to
            tmp="draw("+text(Nk_1)+opcindy+");"; 
            parse(tmp);
           ); //190126to
        );
      );
    );
  );
  grestore(); 
  layer(0);
);
Drwxy():=Drwxy(0,[]); //190103from
Drwxy(Arg):=(
  if(islist(Arg),Drwxy(0,Arg); Drwxy(Arg,[]));
);
Drwxy(add):=Drwxy(add,[]);
Drwxy(add,optionsorg):=( //190103to
  regional(options,color,eqL,strL,org,xrng,yrng,ax,st,nn,size,
  linesty,colorax,colorla,tmp,tmp1,tmp2);
  options=optionsorg;
  tmp=Divoptions(options);
  color=tmp_(length(tmp)-2);
  eqL=tmp_5;
  org=GENTEN; 
  xrng=[XMIN,XMAX];  //190103
  yrng=[YMIN,YMAX];  //190103
  ax=AXSTYLE;
  linesty=ax_8;
  if(length(ax_9)>0, //190427
    if(isstring(ax_9),colorax=ax_9,colorax=text(ax_9));
  ,
    colorax=KCOLOR; //190427
  );
  colorax="Color="+colorax; //190427[if removed]
  if(isstring(ax_10),colorla=ax_10,colorla=text(ax_10));
  if(length(colorla)>0, //181217from
    colorla="Color="+colorla;
  ,
    if(length(colorax)>0,
      colorla=colorax;
    );
  ); //181217to
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="O", //190103from
      org=parse(tmp_2);
      options=remove(options,[#]);
    );  //190103to
    if(tmp1=="X",
      xrng=parse(tmp_2);
      options=remove(options,[#]);
    );
    if(tmp1=="Y",
      yrng=parse(tmp_2);
      options=remove(options,[#]);
    );
    if(tmp1=="A",
      tmp2=tokenize(tmp_2,",");
      st=1; nn=1;
      if(isreal(tmp2_1),
        st=2;
        nn=tmp2_1;
      );
      forall(st..(length(tmp2)),
        tmp=tmp2_#;
        if(length(tmp)>0,ax_nn=tmp);
        nn=nn+1;
      );
      options=remove(options,[#]);
    );
  );
  options=append(options,linesty); //181216
  if(substring(ax_1,0,1)=="a",
    strL=select(options,isstring(#)); //181216
    tmp=select(strL,contains(["dr","da","do","id"],substring(#,0,2)));
    if(length(tmp)==0,options=append(options,YasenStyle));
    tmp=substring(ax_1,1,length(ax_1)); //181216[2lines]
    if(length(tmp)>0,size=parse(tmp),size=YaSize);
    tmp1=concat(options,[size,YaAngle,YaPosition,YaCut,colorax]);//181216
    tmp=[[xrng_1,org_2],[xrng_2,org_2]];
    Lightarrowdata("axx"+text(AXCOUNT),tmp,tmp1);
    tmp=[[org_1,yrng_1],[org_1,yrng_2]];
    Lightarrowdata("axy"+text(AXCOUNT),tmp,tmp1); //190419
  ,
    tmp=[[xrng_1,org_2],[xrng_2,org_2]];
    tmp1=concat(options,[colorax,"Msg=n"]);//181216,190325
    Listplot("-axx"+text(AXCOUNT),tmp,tmp1); 
    tmp=[[org_1,yrng_1],[org_1,yrng_2]];
    Listplot("-axy"+text(AXCOUNT),tmp,tmp1); 
  );
  AXCOUNT=AXCOUNT+1;
  Expr([[xrng_2,org_2],ax_3,ax_2],[colorla]);//181216[3lines]
  Expr([[org_1,yrng_2],ax_5,ax_4],[colorla]);
  Letter([org,ax_7,ax_6],[colorla]);
  if(add==0, //190103
    Addax(0);
  );
);
Lightarrowdata(ptlist):=Lightarrowdata(ptlist,[]); //181110from
Lightarrowdata(Arg1,Arg2):=(
  regional(name);
  if(isstring(Arg1),
    Lightarrowdata(Arg1,Arg2,[]);
  ,
    name="";
    forall(Arg1,
      if(ispoint(#),
        name=name+#.name; //190505
      );
    );
    Lightarrowdata(name,Arg1,Arg2);
  );
);  //181110from
Lightarrowdata(nm,ptlist,optionsorg):=(
  regional(options,Ltype,Noflg,opstr,opcindy,eqL,reL,strL,color,size,coord,lineflg,
      flg,lineflg,cutend,tmp,tmp1,tmp2,pA,pB,angle,segpos,cut,scaley,Ev,Nv,pP);
  pA=Pcrd(ptlist_1); pB=Pcrd(ptlist_2);
  scaley=SCALEY; //190412
  Setscaling(1); 
  ptlist=[];
  forall(ptlistorg,
    if(ispoint(#),tmp=[#.x, scaley*#.y], tmp=[#_1,scaley*#_2]);
    ptlist=append(ptlist,tmp);
  );
  options=optionsorg;
  tmp=select(options,isstring(#)); //181214from
  tmp1=select(tmp,contains(["dr","da","do","id"],substring(#,0,2)));
  if(length(tmp1)==0,options=append(options,YasenStyle)); //181214to
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  reL=tmp_6;
  strL=tmp_7;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  tmp1=[YaSize,YaAngle,YaPosition,YaCut]; //181214from
  forall(1..(length(reL)),
    if(reL_#<0, reL_#=tmp1_#);
  ); 
  forall((length(reL)+1)..4,
    reL=append(reL,tmp1_#);
  );
  size=reL_1;
  angle=reL_2;
  segpos=reL_3;
  cut=reL_4;
  lineflg=0;
  if(contains(strL,"l")%contains(strL,"L"),
    lineflg=1;
  );//181018from
  options=remove(options,strL);
  cutend=[0,0];//180719
  coord="P";//181018
  lineflg=1; //190504
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,2));
    tmp2=tmp_2;
    if(tmp1=="CU",//180719from
      tmp2=replace(tmp2,"[","");
      tmp2=replace(tmp2,"]","");
      cutend=tokenize(tmp2,",");
      if(length(cutend)==1,cutend=[cutend_1,cutend_1]);
      options=remove(options,[#]);
    );
    if(tmp1=="LI",//190504from
      tmp2=Toupper(substring(tmp2,0,1));
      if(tmp2=="N",lineflg=0);
      options=remove(options,[#]);
    );//190504to
  );
  if(Noflg<3,
    tmp="ar"+nm+"="+Textformat([pA,pB],5)+";";
    parse(tmp);
  );
  if(Noflg<2,
    if(isstring(Ltype),
      if(lineflg==1, //190504from
        Listplot("-ar"+nm,[LLcrd(pA),LLcrd(pB)],append(options,"Msg=n"));
      ,
        tmp=pB;
        pB=pA;
        pA=pB-tmp;
      );  //190504to
      size=0.2*size;
      angle=angle*pi/180;
      pP=pA+segpos*(pB-pA);
      Ev=-1/|pB-pA|*(pB-pA);
      Nv=[-Ev_2, Ev_1];
      tmp1=pP+size*cos(angle)*Ev+size*sin(angle)*Nv;
      tmp2=pP+size*cos(angle)*Ev-size*sin(angle)*Nv;
      ArrowheadNumber=ArrowheadNumber+1;
      Listplot("-arh"+nm,[tmp1,pP,tmp2],append(options,"Msg=n"));
      Setscaling(scaley);
    ,
      if(Noflg==1,Ltype=0);
    );
  );
  Setscaling(scaley); //190412
  [Lcrd(pA),Lcrd(pB)];
);
Setscaling(sc):=(
  regional(tmp);
  tmp=format(sc,5);
  if(!islist(sc),
    SCALEX=1;
    SCALEY=sc;
    Com0th("Setscaling("+tmp+")");
  ,
    SCALEX=sc_1;
    SCALEY=sc_2;
    Com0th("Setscaling("+tmp_1+","+tmp_2+")");
  );
  Setwindow("Msg=no");
);
Addax(param):=(
  ADDAXES=text(param);
);
Dashlinedata(dataorg,sen,gap,ptn):=(
  regional(data,eps,dtall,len,lenlist,ii,lenall,kari,
      naga,tobi,nsen,seglist,segunit,hajime,owari,jj,
      flg,tt,ptL,out,tmp,tmp1,tmp2);
  eps=10.0^(-6);
  if(isstring(dataorg),data=parse(dataorg),data=dataorg);
  dtall=length(data);
  out=[];
  len=0; lenlist=[0];
  forall(2..dtall,ii,
    len=len+|data_ii-data_(ii-1)|;
    lenlist=append(lenlist,len);
  );
  lenall=lenlist_dtall;
  if(lenall>0,
    kari=(sen+gap)*0.1;naga=sen*0.1;tobi=gap*0.1;
    if(|data_1-data_dtall|<eps,
      nsen=max([re(ceil(lenall/kari)),3]);
      segunit=lenall/nsen;
      naga=segunit*sen/(sen+gap);
      tobi=segunit*gap/(sen+gap);
      seglist=apply(0..(nsen-1),#*segunit);
    ,
      if(ptn==0,
        nsen=max([re(ceil((lenall+tobi)/kari)),3]);
        segunit=lenall*(sen+gap)/(nsen*sen+(nsen-1)*gap);
        naga=segunit*sen/(sen+gap);
        tobi=segunit*gap/(sen+gap);
        seglist=apply(0..(nsen-1),#*segunit);
      ,
        nsen=max([re(ceil((lenall+naga)/kari)),3]);
        segunit=lenall*(sen+gap)/((nsen-1)*sen+nsen*gap);
        naga=segunit*sen/(sen+gap);
        tobi=segunit*gap/(sen+gap);
        seglist=apply(0..(nsen-2),tobi+#*segunit);
      );
    );
    hajime=1;owari=1;
    forall(1..(length(seglist)),ii,
      len=seglist_ii;
      flg=0;
      forall(owari..dtall,jj,
        if(flg==0,
          if(len<lenlist_jj-eps,
            flg=jj;
          );
        );
      );
      if(flg>0,hajime=flg-1);
      flg=0;
      forall(hajime..dtall,jj,
        if(flg==0,
          if(len+naga<lenlist_jj-eps,
            flg=jj;
          );
        );
      );
      if(flg>0,owari=flg-1);
      tt=len-lenlist_hajime;
      tt=tt/(lenlist_(hajime+1)-lenlist_hajime);
      tmp=data_hajime+tt*(data_(hajime+1)-data_hajime);
      ptL=[tmp];
      forall((hajime+1)..owari,jj,
        ptL=append(ptL,data_jj);
      );
      tt=(len+naga-lenlist_owari);
      tt=tt/(lenlist_(owari+1)-lenlist_owari);
      tmp=data_owari+tt*(data_(owari+1)-data_owari);
      ptL=append(ptL,tmp);
      out=append(out,ptL);
    );
  );
  out;
);
Ketcindyjsfigure=1;
Ketcindyjsscale=1.5;
eqG="-((2*G*Q-2*G*G+G^2)*R-g*sin(F))/((P-F)*R-L0)";
eqQ="((m1*G^2*P-m1*F*G^2)*R^2+((-g*m1*cos(F))-L0*m1*G^2+g*m2)*R)/((m2+m1)*R^2+I0)";
vL=[[0,0,0,0,0.6],[0.1,-0.00222,-0.04387,0.05929,0.5834],[0.2,-0.00858,-0.08181,0.11621,0.5527],[0.3,-0.01825,-0.10972,0.16943,0.50979],[0.4,-0.03009,-0.12468,0.21783,0.45672],[0.5,-0.0427,-0.1251,0.2605,0.39555],[0.6,-0.05461,-0.11079,0.29673,0.32812],[0.7,-0.0644,-0.0828,0.32597,0.25604],[0.8,-0.07079,-0.04325,0.34783,0.18064],[0.9,-0.07276,0.00493,0.36202,0.10298],[1,-0.06963,0.05818,0.36838,0.02394],[1.1,-0.06108,0.11264,0.36679,-0.05571],[1.2,-0.0472,0.1643,0.35724,-0.13526],[1.3,-0.02844,0.20932,0.33977,-0.21388],[1.4,-0.00567,0.24423,0.31452,-0.29063],[1.5,0.01997,0.26622,0.28175,-0.36426],[1.6,0.04708,0.27339,0.24183,-0.43325],[1.7,0.07413,0.26504,0.19531,-0.49572],[1.8,0.09959,0.24183,0.14297,-0.54945],[1.9,0.12207,0.20595,0.0858,-0.59203],[2,0.14048,0.16106,0.02502,-0.62101],[2.1,0.15414,0.11203,-0.03788,-0.63413],[2.2,0.16293,0.06452,-0.10122,-0.62962],[2.3,0.16729,0.0243,-0.16318,-0.60649],[2.4,0.16821,-0.00341,-0.22189,-0.56463],[2.5,0.16716,-0.01473,-0.27551,-0.50489],[2.6,0.16589,-0.00755,-0.32232,-0.42892],[2.7,0.16627,0.01811,-0.36083,-0.33905],[2.8,0.17006,0.06016,-0.38976,-0.23794],[2.9,0.17872,0.11464,-0.40814,-0.12851],[3,0.19322,0.17614,-0.41528,-0.01373],[3.1,0.21397,0.2384,-0.41081,0.1033],[3.2,0.24071,0.29488,-0.39465,0.21934],[3.3,0.27255,0.3395,-0.36709,0.3309],[3.4,0.30804,0.36729,-0.32875,0.43425],[3.5,0.34533,0.37504,-0.28064,0.52551],[3.6,0.38235,0.36184,-0.22417,0.60094],[3.7,0.41705,0.32931,-0.16109,0.65731],[3.8,0.4477,0.28151,-0.09343,0.69229],[3.9,0.47304,0.22441,-0.02338,0.70488],[4,0.49251,0.16509,0.04681,0.69541],[4.1,0.50623,0.1107,0.11502,0.6655],[4.2,0.51503,0.06758,0.17931,0.61765],[4.3,0.52028,0.04047,0.23805,0.55486],[4.4,0.52375,0.03213,0.28989,0.48017],[4.5,0.52736,0.04327,0.33378,0.39635],[4.6,0.53301,0.07265,0.36893,0.30571],[4.7,0.54241,0.1174,0.39476,0.21005],[4.8,0.55687,0.17335,0.41082,0.11069],[4.9,0.57728,0.23542,0.4168,0.00858],[5,0.60397,0.29795,0.41247,-0.09554],[5.1,0.63669,0.3551,0.39765,-0.20094],[5.2,0.67462,0.40115,0.37227,-0.30673],[5.3,0.71638,0.431,0.33633,-0.41161],[5.4,0.76014,0.44058,0.29004,-0.5136],[5.5,0.80374,0.42749,0.2338,-0.60989],[5.6,0.84487,0.39148,0.16838,-0.69662],[5.7,0.88135,0.33507,0.09495,-0.76898],[5.8,0.91138,0.26368,0.01525,-0.82139],[5.9,0.93385,0.18553,-0.06847,-0.84814],[6,0.94859,0.11074,-0.15335,-0.84418],[6.1,0.95647,0.04989,-0.23616,-0.80613],[6.2,0.95935,0.01222,-0.3134,-0.73295],[6.3,0.9599,0.00385,-0.38163,-0.62623],[6.4,0.96116,0.02653,-0.43766,-0.48986],[6.5,0.96615,0.07726,-0.47879,-0.32936],[6.6,0.97731,0.14866,-0.50294,-0.15117],[6.7,0.99621,0.23004,-0.50867,0.0378],[6.8,1.02323,0.30882,-0.49527,0.23008],[6.9,1.05746,0.37225,-0.46281,0.41746],[7,1.0968,0.40932,-0.41224,0.59078],[7.1,1.13819,0.41264,-0.34545,0.74027],[7.2,1.17812,0.38009,-0.2653,0.85669],[7.3,1.21313,0.31557,-0.17546,0.93298],[7.4,1.24047,0.22851,-0.08016,0.96573],[7.5,1.25852,0.13194,0.01626,0.95591],[7.6,1.26701,0.03983,0.10976,0.9083],[7.7,1.26705,-0.03556,0.1969,0.83004],[7.8,1.26076,-0.08551,0.275,0.72893],[7.9,1.25095,-0.10561,0.34216,0.6121],[8,1.24065,-0.09559,0.39709,0.4852],[8.1,1.23273,-0.05864,0.439,0.35223],[8.2,1.22963,-0.00058,0.46742,0.21567],[8.3,1.23307,0.07106,0.48206,0.07687],[8.4,1.244,0.14764,0.48274,-0.06357],[8.5,1.26246,0.22008,0.4693,-0.20536],[8.6,1.28758,0.27941,0.44163,-0.34803],[8.7,1.31763,0.31735,0.3997,-0.49044],[8.8,1.35011,0.32712,0.34363,-0.63026],[8.9,1.38196,0.30442,0.27387,-0.76339],[9,1.40988,0.24856,0.19138,-0.88349],[9.1,1.4307,0.16357,0.09789,-0.98187],[9.2,1.44192,0.05881,-0.00392,-1.048],[9.3,1.44227,-0.05153,-0.11027,-1.07106],[9.4,1.432,-0.15042,-0.21639,-1.04227],[9.5,1.41312,-0.22141,-0.31684,-0.9574],[9.6,1.38906,-0.25257,-0.40605,-0.81836],[9.7,1.3641,-0.2394,-0.47896,-0.63296],[9.8,1.34254,-0.18586,-0.53149,-0.41299],[9.9,1.3279,-0.10332,-0.56085,-0.17187],[10,1.3223,-0.00813,-0.5656,0.07697],[10.1,1.32608,0.08138,-0.54563,0.32049],[10.2,1.3378,0.14799,-0.50211,0.54586],[10.3,1.35447,0.17852,-0.43749,0.74043],[10.4,1.37207,0.16635,-0.35544,0.89277],[10.5,1.38634,0.11285,-0.26063,0.99451],[10.6,1.39355,0.02702,-0.15835,1.04225],[10.7,1.39115,-0.07669,-0.05392,1.03829],[10.8,1.37817,-0.18185,0.04781,0.98972],[10.9,1.35523,-0.27358,0.14286,0.90633],[11,1.32427,-0.34091,0.22826,0.79839],[11.1,1.28807,-0.37783,0.30203,0.67491],[11.2,1.24977,-0.38303,0.36296,0.54284],[11.3,1.21244,-0.35912,0.41047,0.407],[11.4,1.17874,-0.31144,0.44434,0.27037],[11.5,1.15071,-0.24714,0.46458,0.13459],[11.6,1.1296,-0.17436,0.47131,0.00045],[11.7,1.11584,-0.10153,0.46473,-0.1316],[11.8,1.10902,-0.03688,0.44508,-0.26108],[11.9,1.10794,0.01208,0.41263,-0.38706],[12,1.1107,0.03918,0.36784,-0.50783],[12.1,1.1149,0.04017,0.31133,-0.62059],[12.2,1.11781,0.01346,0.24412,-0.72131],[12.3,1.11672,-0.03924,0.16765,-0.80471],[12.4,1.10927,-0.11255,0.08395,-0.86472],[12.5,1.09381,-0.19768,-0.00431,-0.89523],[12.6,1.06971,-0.28336,-0.09394,-0.89133],[12.7,1.03752,-0.35761,-0.18134,-0.85046],[12.8,0.99892,-0.40992,-0.26281,-0.77328],[12.9,0.95651,-0.4332,-0.33491,-0.66365],[13,0.91334,-0.42502,-0.39467,-0.52792],[13.1,0.87248,-0.38779,-0.43987,-0.37369],[13.2,0.83654,-0.32798,-0.46905,-0.20872],[13.3,0.80733,-0.25492,-0.4815,-0.0402],[13.4,0.78565,-0.17923,-0.47719,0.12544],[13.5,0.77122,-0.11144,-0.4567,0.28237],[13.6,0.76279,-0.06063,-0.42119,0.42519],[13.7,0.7583,-0.03334,-0.37231,0.54881],[13.8,0.75522,-0.03276,-0.31222,0.64876],[13.9,0.75087,-0.05827,-0.24346,0.72159],[14,0.74283,-0.10567,-0.16887,0.76539],[14.1,0.72924,-0.16793,-0.09136,0.78016],[14.2,0.70904,-0.23642,-0.01375,0.76776],[14.3,0.68205,-0.30233,0.0614,0.73157],[14.4,0.64892,-0.35795,0.13191,0.67582],[14.5,0.611,-0.39752,0.19606,0.60502],[14.6,0.57007,-0.41766,0.25256,0.52338],[14.7,0.52815,-0.41735,0.3005,0.43448],[14.8,0.48725,-0.39766,0.33931,0.34118],[14.9,0.44917,-0.36132,0.36866,0.2456],[15,0.41541,-0.31227,0.3884,0.14926],[15.1,0.38699,-0.25522,0.39852,0.05326],[15.2,0.36446,-0.19527,0.39909,-0.04159],[15.3,0.34786,-0.13755,0.39027,-0.13454],[15.4,0.33671,-0.08693,0.37227,-0.22481],[15.5,0.33009,-0.04768,0.34543,-0.31139],[15.6,0.32668,-0.02316,0.31016,-0.39294],[15.7,0.32489,-0.01554,0.26706,-0.46776],[15.8,0.32299,-0.0255,0.2169,-0.53375],[15.9,0.31924,-0.05202,0.16069,-0.58847],[16,0.31212,-0.09229,0.09967,-0.62937],[16.1,0.30047,-0.14188,0.03536,-0.65398],[16.2,0.28362,-0.19512,-0.03051,-0.66033],[16.3,0.26153,-0.24572,-0.09605,-0.64719],[16.4,0.23477,-0.28752,-0.15929,-0.61438],[16.5,0.2045,-0.31538,-0.2183,-0.5628],[16.6,0.17229,-0.32576,-0.27129,-0.49436],[16.7,0.13998,-0.31723,-0.3167,-0.41172],[16.8,0.10945,-0.29047,-0.35326,-0.31798],[16.9,0.0824,-0.24818,-0.38003,-0.21638],[17,0.06019,-0.19462,-0.39638,-0.11007],[17.1,0.04368,-0.13513,-0.40199,-0.00206],[17.2,0.03317,-0.07551,-0.39683,0.10479],[17.3,0.02839,-0.0215,-0.38116,0.20773],[17.4,0.02851,0.02185,-0.35551,0.30406],[17.5,0.03227,0.05062,-0.32066,0.39114],[17.6,0.03807,0.06247,-0.27767,0.46642],[17.7,0.04418,0.05686,-0.22785,0.52763],[17.8,0.0489,0.03518,-0.17268,0.57296],[17.9,0.05078,0.00057,-0.11382,0.60126],[18,0.04873,-0.0425,-0.05301,0.61221],[18.1,0.04217,-0.08878,0.00805,0.6063],[18.2,0.03105,-0.1329,0.06773,0.58479],[18.3,0.01583,-0.16995,0.12455,0.54947],[18.4,-0.00257,-0.19604,0.17724,0.50248],[18.5,-0.02292,-0.20853,0.22473,0.44602],[18.6,-0.04378,-0.20621,0.26619,0.38219],[18.7,-0.06367,-0.18921,0.30099,0.31287],[18.8,-0.08118,-0.15891,0.32864,0.23963],[18.9,-0.09509,-0.11764,0.34882,0.16374],[19,-0.10444,-0.06851,0.36133,0.08625],[19.1,-0.10865,-0.01513,0.36605,0.00798],[19.2,-0.10746,0.03866,0.36293,-0.07031],[19.3,-0.10103,0.08896,0.35201,-0.14788],[19.4,-0.0899,0.13212,0.3334,-0.22393],[19.5,-0.07495,0.16493,0.30731,-0.29747],[19.6,-0.05735,0.18489,0.27403,-0.36729],[19.7,-0.03846,0.19044,0.23402,-0.43188],[19.8,-0.01976,0.18118,0.18789,-0.48946],[19.9,-0.00269,0.15807,0.13643,-0.538],[20,0.01147,0.12343,0.08066,-0.57534],[20.1,0.02173,0.0809,0.02181,-0.59939],[20.2,0.02754,0.03514,-0.03871,-0.6083],[20.3,0.02883,-0.00857,-0.0993,-0.60076],[20.4,0.02607,-0.04499,-0.15829,-0.57615],[20.5,0.02023,-0.06949,-0.21397,-0.53467],[20.6,0.01269,-0.07869,-0.26469,-0.47733],[20.7,0.00507,-0.07082,-0.30896,-0.40579],[20.8,-0.00091,-0.04598,-0.34545,-0.32224],[20.9,-0.00362,-0.00609,-0.37309,-0.22914],[21,-0.00174,0.04534,-0.39105,-0.12908],[21.1,0.00567,0.10357,-0.39876,-0.02469],[21.2,0.01902,0.16313,-0.39593,0.08136],[21.3,0.03815,0.2183,-0.38252,0.18634],[21.4,0.06235,0.26374,-0.35879,0.28738],[21.5,0.09042,0.29497,-0.32528,0.38148],[21.6,0.12077,0.30894,-0.28283,0.46554],[21.7,0.15159,0.30441,-0.23261,0.53655],[21.8,0.18106,0.28223,-0.17605,0.59183],[21.9,0.20754,0.24526,-0.11484,0.62934],[22,0.22977,0.19809,-0.05081,0.64793],[22.1,0.24701,0.14645,0.01411,0.64747],[22.2,0.25912,0.09648,0.07807,0.62885],[22.3,0.26655,0.05392,0.13933,0.59376],[22.4,0.27031,0.0235,0.19635,0.54446],[22.5,0.27177,0.00849,0.24783,0.4834],[22.6,0.27257,0.01044,0.29272,0.41297],[22.7,0.27442,0.02926,0.33018,0.33532],[22.8,0.27893,0.06332,0.3596,0.25224],[22.9,0.2875,0.10975,0.3805,0.16516],[23,0.30117,0.16469,0.39254,0.07516],[23.1,0.32057,0.22362,0.39546,-0.0169],[23.2,0.34586,0.28162,0.38911,-0.11028],[23.3,0.3767,0.33373,0.37339,-0.2042],[23.4,0.41225,0.37522,0.34828,-0.29771],[23.5,0.45125,0.40198,0.3139,-0.38949],[23.6,0.49205,0.41086,0.2705,-0.47775],[23.7,0.53277,0.40016,0.21855,-0.56004],[23.8,0.57143,0.37001,0.1588,-0.63323],[23.9,0.60619,0.32272,0.09233,-0.69358],[24,0.63555,0.26284,0.02065,-0.73694],[24.1,0.65856,0.197,-0.05435,-0.75919],[24.2,0.67502,0.13328,-0.13036,-0.75679],[24.3,0.68557,0.08009,-0.2048,-0.72737],[24.4,0.69165,0.045,-0.27491,-0.67017],[24.5,0.69536,0.03338,-0.33794,-0.58618],[24.6,0.69919,0.04756,-0.39134,-0.47803],[24.7,0.70569,0.08629,-0.43286,-0.34948],[24.8,0.71712,0.14496,-0.4607,-0.20504],[24.9,0.7351,0.2161,-0.4735,-0.04959],[25,0.76044,0.29032,-0.47042,0.11164],[25.1,0.79293,0.35746,-0.45117,0.27303],[25.2,0.83137,0.4078,-0.41602,0.42828],[25.3,0.87366,0.43348,-0.36595,0.57042],[25.4,0.91708,0.42981,-0.30262,0.69219],[25.5,0.95862,0.39629,-0.22842,0.78677],[25.6,0.99547,0.33699,-0.14635,0.84892],[25.7,1.02542,0.26002,-0.05981,0.87599],[25.8,1.04724,0.17614,0.02768,0.86835],[25.9,1.0608,0.09672,0.1128,0.82915],[26,1.06708,0.0319,0.19263,0.76339],[26.1,1.06792,-0.0109,0.26479,0.67686],[26.2,1.06577,-0.02763,0.32749,0.57509],[26.3,1.06329,-0.01769,0.37945,0.46271],[26.4,1.06305,0.01658,0.4198,0.34323],[26.5,1.06726,0.07046,0.44794,0.219],[26.6,1.07758,0.13753,0.46349,0.09146],[26.7,1.09496,0.21026,0.46615,-0.03861],[26.8,1.11955,0.28055,0.4557,-0.17076],[26.9,1.15071,0.34022,0.43195,-0.30443],[27,1.18698,0.38155,0.39479,-0.43864],[27.1,1.22619,0.39798,0.34426,-0.57145],[27.2,1.26559,0.3849,0.28066,-0.69951],[27.3,1.30213,0.34072,0.20469,-0.8176],[27.4,1.33277,0.26782,0.11771,-0.91843],[27.5,1.35496,0.1733,0.02188,-0.99287],[27.6,1.3671,0.06894,-0.07965,-1.03093],[27.7,1.36892,-0.03013,-0.18278,-1.02352],[27.8,1.36178,-0.10804,-0.28263,-0.96469],[27.9,1.34847,-0.15163,-0.37396,-0.85335],[28,1.33285,-0.15362,-0.45169,-0.69384],[28.1,1.31913,-0.11439,-0.5114,-0.49489],[28.2,1.31109,-0.04194,-0.54972,-0.26784],[28.3,1.31139,0.04975,-0.56444,-0.02496],[28.4,1.3211,0.14327,-0.5546,0.22125],[28.5,1.3395,0.22064,-0.52051,0.45788],[28.6,1.36417,0.26639,-0.4638,0.67147],[28.7,1.39138,0.27046,-0.38743,0.84869],[28.8,1.41678,0.2305,-0.29566,0.97811],[28.9,1.4362,0.15256,-0.19365,1.05273],[29,1.44645,0.04972,-0.08699,1.07161],[29.1,1.44588,-0.06114,0.01897,1.03985],[29.2,1.43452,-0.16323,0.1196,0.96677],[29.3,1.41398,-0.24312,0.21131,0.86329],[29.4,1.38693,-0.29247,0.29159,0.73967],[29.5,1.35661,-0.30823,0.35886,0.60422],[29.6,1.32636,-0.2919,0.41224,0.46284],[29.7,1.29914,-0.24843,0.45135,0.31927],[29.8,1.27734,-0.18505,0.47609,0.17556],[29.9,1.26251,-0.11036,0.48649,0.03265],[30,1.25534,-0.03352,0.48266,-0.1091],[30.1,1.25557,0.03627,0.46472,-0.24938],[30.2,1.26207,0.0904,0.43285,-0.38748],[30.3,1.27288,0.12148,0.38735,-0.52184],[30.4,1.28541,0.12404,0.3287,-0.64961],[30.5,1.29664,0.09551,0.25779,-0.76626],[30.6,1.3035,0.03706,0.17603,-0.86552],[30.7,1.30324,-0.04571,0.08553,-0.93962],[30.8,1.29388,-0.1428,-0.01078,-0.98028],[30.9,1.27464,-0.24082,-0.10917,-0.98026],[31,1.24617,-0.32522,-0.20532,-0.93523],[31.1,1.21049,-0.38314,-0.2947,-0.84515],[31.2,1.17072,-0.40619,-0.37299,-0.71462],[31.3,1.1305,-0.39209,-0.43654,-0.55186],[31.4,1.09341,-0.34486,-0.48262,-0.36695],[31.5,1.06234,-0.27363,-0.50954,-0.17015],[31.6,1.03907,-0.19078,-0.51657,0.02908],[31.7,1.02411,-0.10987,-0.50393,0.22222],[31.8,1.01661,-0.04364,-0.47259,0.40148],[31.9,1.01455,-0.00225,-0.42434,0.55957],[32,1.01512,0.00816,-0.36161,0.68986],[32.1,1.0151,-0.01367,-0.28748,0.78699],[32.2,1.01143,-0.06393,-0.20543,0.84771],[32.3,1.00163,-0.13462,-0.11917,0.87154],[32.4,0.98417,-0.21516,-0.03228,0.86079],[32.5,0.95864,-0.29439,0.05199,0.82006],[32.6,0.92567,-0.36243,0.13092,0.75524],[32.7,0.88678,-0.41191,0.20244,0.67249],[32.8,0.84405,-0.43862,0.26501,0.57742],[32.9,0.79986,-0.44137,0.31766,0.47467],[33,0.75653,-0.42161,0.35981,0.36774],[33.1,0.71617,-0.38277,0.39116,0.2591],[33.2,0.68045,-0.32973,0.41163,0.15039],[33.3,0.65051,-0.26817,0.42127,0.04269],[33.4,0.6269,-0.20415,0.42023,-0.06324],[33.5,0.60956,-0.14371,0.4087,-0.16671],[33.6,0.59785,-0.09243,0.38699,-0.26689],[33.7,0.59061,-0.05516,0.35547,-0.36263],[33.8,0.58623,-0.03556,0.31467,-0.45231],[33.9,0.58283,-0.03572,0.26528,-0.53376],[34,0.57841,-0.05588,0.20828,-0.60427],[34.1,0.57105,-0.09411,0.1449,-0.66073],[34.2,0.55912,-0.14632,0.07671,-0.69987],[34.3,0.54152,-0.20654,0.0056,-0.71874],[34.4,0.51779,-0.26753,-0.06629,-0.71517],[34.5,0.48824,-0.32175,-0.13665,-0.68819],[34.6,0.45389,-0.36236,-0.20316,-0.63831],[34.7,0.41639,-0.38428,-0.26361,-0.56747],[34.8,0.37776,-0.38482,-0.31606,-0.4788],[34.9,0.34014,-0.36401,-0.3589,-0.37614],[35,0.30558,-0.3244,-0.39095,-0.2636],[35.1,0.27574,-0.27061,-0.41143,-0.1452],[35.2,0.25173,-0.20868,-0.41993,-0.02473],[35.3,0.23405,-0.14533,-0.41642,0.09434],[35.4,0.22249,-0.08723,-0.40121,0.20872],[35.5,0.21623,-0.04034,-0.37494,0.31528],[35.6,0.21389,-0.00926,-0.33852,0.41097],[35.7,0.21375,0.00326,-0.2932,0.49293],[35.8,0.2139,-0.00343,-0.24048,0.55866],[35.9,0.21248,-0.02772,-0.18207,0.60626],[36,0.20789,-0.06605,-0.11987,0.63464],[36.1,0.19897,-0.11334,-0.05579,0.64371],[36.2,0.18511,-0.16372,0.00826,0.63435],[36.3,0.16632,-0.21126,0.07052,0.60824],[36.4,0.14313,-0.25071,0.12942,0.56768],[36.5,0.11658,-0.27801,0.18366,0.5152],[36.6,0.08803,-0.29056,0.23215,0.45336],[36.7,0.059,-0.28734,0.27409,0.38449],[36.8,0.03107,-0.26877,0.30888,0.31061],[36.9,0.0057,-0.23655,0.3361,0.23338],[37,-0.01587,-0.19338,0.35549,0.1541],[37.1,-0.03272,-0.14264,0.36689,0.07381],[37.2,-0.04428,-0.08821,0.37025,-0.00665],[37.3,-0.05037,-0.0341,0.36558,-0.08655],[37.4,-0.05124,0.0157,0.35298,-0.16513],[37.5,-0.0475,0.05753,0.33263,-0.24156],[37.6,-0.04011,0.08826,0.30478,-0.3148],[37.7,-0.0303,0.10558,0.26981,-0.38357],[37.8,-0.01948,0.1082,0.22826,-0.44634],[37.9,-0.00915,0.09607,0.18081,-0.50127],[38,-0.00072,0.07049,0.12834,-0.54636],[38.1,0.00459,0.03414,0.07193,-0.57953],[38.2,0.00588,-0.00905,0.01289,-0.59885],[38.3,0.00271,-0.05426,-0.04732,-0.60275],[38.4,-0.00486,-0.09625,-0.10711,-0.59025],[38.5,-0.01626,-0.12998,-0.16481,-0.56109],[38.6,-0.03044,-0.15119,-0.21879,-0.51585],[38.7,-0.04598,-0.15694,-0.26749,-0.45581],[38.8,-0.06127,-0.14597,-0.30952,-0.38288],[38.9,-0.07463,-0.11877,-0.34371,-0.29934],[39,-0.08455,-0.07754,-0.36912,-0.20769],[39.1,-0.08979,-0.0259,-0.38506,-0.11045],[39.2,-0.08954,0.03149,-0.39111,-0.01015],[39.3,-0.08348,0.08942,-0.38707,0.0907],[39.4,-0.07181,0.14258,-0.37303,0.18959],[39.5,-0.05528,0.18611,-0.34931,0.28392],[39.6,-0.03505,0.21604,-0.31649,0.37105],[39.7,-0.01262,0.22976,-0.27543,0.4483],[39.8,0.01033,0.22634,-0.22724,0.51314],[39.9,0.03211,0.20668,-0.17329,0.56336],[40,0.05121,0.17346,-0.11511,0.59732],[40.1,0.06648,0.13085,-0.0544,0.61413],[40.2,0.07724,0.08399,0.00714,0.61376],[40.3,0.08332,0.03837,0.06781,0.59704],[40.4,0.08513,-0.00085,0.12605,0.56543],[40.5,0.08351,-0.02936,0.18046,0.52089],[40.6,0.07972,-0.04412,0.22987,0.46555],[40.7,0.0752,-0.04353,0.27328,0.40154],[40.8,0.07153,-0.02747,0.30995,0.3308],[40.9,0.07019,0.00283,0.33927,0.25497],[41,0.07249,0.04501,0.36082,0.17543],[41.1,0.07948,0.09582,0.37427,0.09324],[41.2,0.09181,0.15136,0.37941,0.00928],[41.3,0.10976,0.20737,0.37609,-0.0757],[41.4,0.13316,0.25948,0.36426,-0.16094],[41.5,0.16139,0.30349,0.34392,-0.24559],[41.6,0.19346,0.33564,0.3152,-0.32855],[41.7,0.22802,0.35293,0.27832,-0.4084],[41.8,0.26348,0.35346,0.23368,-0.48327],[41.9,0.29814,0.33676,0.18191,-0.55083],[42,0.3303,0.304,0.12385,-0.6083],[42.1,0.3585,0.25819,0.06069,-0.65261],[42.2,0.38165,0.20406,-0.00612,-0.6806],[42.3,0.39923,0.14772,-0.0748,-0.68945],[42.4,0.41135,0.09603,-0.1433,-0.67702],[42.5,0.41882,0.05567,-0.20945,-0.6422],[42.6,0.42306,0.03225,-0.271,-0.58511],[42.7,0.42596,0.02944,-0.32577,-0.50713],[42.8,0.42967,0.04839,-0.3718,-0.41061],[42.9,0.43632,0.08756,-0.40738,-0.29865],[43,0.44773,0.14289,-0.43113,-0.17475],[43.1,0.46523,0.20823,-0.44206,-0.04265],[43.2,0.48946,0.27608,-0.43952,0.09375],[43.3,0.52026,0.33833,-0.4233,0.23026],[43.4,0.55668,0.38726,-0.39362,0.36229],[43.5,0.59705,0.41643,-0.35116,0.4848],[43.6,0.63916,0.42164,-0.29715,0.59248],[43.7,0.68053,0.40174,-0.23333,0.68018],[43.8,0.71874,0.35893,-0.16193,0.74351],[43.9,0.75173,0.29868,-0.08554,0.7796],[44,0.77815,0.22887,-0.00695,0.78752],[44.1,0.79749,0.15856,0.07106,0.76837],[44.2,0.81014,0.09658,0.14591,0.72499],[44.3,0.81733,0.05025,0.21537,0.66122],[44.4,0.82089,0.02454,0.27762,0.58129],[44.5,0.82301,0.02172,0.33122,0.48916],[44.6,0.82599,0.04147,0.37515,0.38816],[44.7,0.83197,0.08117,0.40865,0.28085],[44.8,0.84274,0.13639,0.43117,0.16903],[44.9,0.85957,0.2014,0.44234,0.05386],[45,0.88313,0.2696,0.44186,-0.06389],[45.1,0.91337,0.33396,0.4295,-0.18362],[45.2,0.94956,0.38746,0.40509,-0.30461],[45.3,0.99028,0.4236,0.36857,-0.42569],[45.4,1.03351,0.43695,0.32002,-0.54488],[45.5,1.07678,0.4239,0.25976,-0.65907],[45.6,1.11737,0.38343,0.18852,-0.76365],[45.7,1.15263,0.31795,0.10755,-0.85248],[45.8,1.18033,0.23374,0.0188,-0.91808],[45.9,1.19908,0.14085,-0.07502,-0.95244],[46,1.20864,0.05207,-0.1704,-0.94829],[46.1,1.21009,-0.01908,-0.26322,-0.90066],[46.2,1.2058,-0.06106,-0.34903,-0.80815],[46.3,1.19909,-0.06683,-0.42343,-0.6734],[46.4,1.19369,-0.03542,-0.48249,-0.50248],[46.5,1.19308,0.02768,-0.523,-0.30375],[46.6,1.19992,0.11154,-0.54263,-0.08665],[46.7,1.21559,0.20153,-0.54005,0.1388],[46.8,1.23989,0.28157,-0.51494,0.36194],[46.9,1.27107,0.33667,-0.46812,0.57117],[47,1.30601,0.35552,-0.40159,0.75411],[47.1,1.34078,0.3329,-0.31858,0.89884],[47.2,1.37127,0.27112,-0.22341,0.99606],[47.3,1.394,0.17975,-0.12112,1.04123],[47.4,1.40672,0.07349,-0.01687,1.03558],[47.5,1.40876,-0.0312,0.08451,0.98539],[47.6,1.40103,-0.11962,0.17902,0.89993],[47.7,1.38574,-0.18119,0.26365,0.78917],[47.8,1.36588,-0.21043,0.33631,0.66194],[47.9,1.34476,-0.20672,0.39572,0.52507],[48,1.32553,-0.17341,0.44116,0.38321],[48.1,1.31086,-0.11671,0.47229,0.23916],[48.2,1.3027,-0.04471,0.48897,0.09432],[48.3,1.30212,0.03348,0.49115,-0.05077],[48.4,1.30928,0.10833,0.47881,-0.19586],[48.5,1.32336,0.17052,0.45199,-0.34056],[48.6,1.34267,0.21154,0.41075,-0.48378],[48.7,1.36473,0.22448,0.35536,-0.62321],[48.8,1.38648,0.20497,0.28637,-0.75479],[48.9,1.40461,0.15229,0.20486,-0.87231],[49,1.41596,0.0704,0.11265,-0.96737],[49.1,1.41801,-0.03157,0.01247,-1.03007],[49.2,1.40943,-0.13982,-0.09195,-1.05048],[49.3,1.39039,-0.23793,-0.19595,-1.02094],[49.4,1.36271,-0.31011,-0.29436,-0.9384],[49.5,1.32963,-0.3448,-0.38195,-0.80564],[49.6,1.29517,-0.33742,-0.45407,-0.63078],[49.7,1.26345,-0.29115,-0.50708,-0.42538],[49.8,1.23791,-0.21596,-0.53855,-0.20206],[49.9,1.22074,-0.12633,-0.5473,0.02701],[50,1.21258,-0.0386,-0.53333,0.25065],[50.1,1.21244,0.03167,-0.4977,0.45838],[50.2,1.21791,0.07211,-0.44252,0.64025],[50.3,1.22561,0.07554,-0.37082,0.7872],[50.4,1.23175,0.04125,-0.28648,0.89221],[50.5,1.23279,-0.02498,-0.19391,0.95159],[50.6,1.22605,-0.11223,-0.09768,0.96577],[50.7,1.21009,-0.2069,-0.00213,0.93913],[50.8,1.18487,-0.29552,0.08902,0.87878],[50.9,1.15157,-0.36702,0.17278,0.79295],[51,1.11229,-0.41412,0.24702,0.68956],[51.1,1.06967,-0.43354,0.31033,0.57525],[51.2,1.0265,-0.42566,0.36188,0.45507],[51.3,0.98535,-0.39367,0.40127,0.33249],[51.4,0.94839,-0.34281,0.42837,0.20972],[51.5,0.9172,-0.27954,0.44325,0.08806],[51.6,0.89266,-0.21097,0.44605,-0.0317],[51.7,0.87494,-0.14427,0.43699,-0.149],[51.8,0.86352,-0.0863,0.41635,-0.26312],[51.9,0.85719,-0.04314,0.3845,-0.373],[52,0.85423,-0.01957,0.34195,-0.47693],[52.1,0.85251,-0.01866,0.2894,-0.57245],[52.2,0.84971,-0.0412,0.22785,-0.65627],[52.3,0.84355,-0.08535,0.15867,-0.72438],[52.4,0.83207,-0.14648,0.08364,-0.77242],[52.5,0.81392,-0.21744,0.00499,-0.79625],[52.6,0.78855,-0.28935,-0.07469,-0.7927],[52.7,0.75633,-0.35284,-0.15258,-0.76027],[52.8,0.71855,-0.39952,-0.2258,-0.69958],[52.9,0.67719,-0.4234,-0.29164,-0.61333],[53,0.63472,-0.42171,-0.34775,-0.50587],[53.1,0.59368,-0.39524,-0.39228,-0.3825],[53.2,0.55638,-0.34793,-0.42391,-0.24874],[53.3,0.52458,-0.28619,-0.44186,-0.10984],[53.4,0.49936,-0.21787,-0.44587,0.02938],[53.5,0.48095,-0.15128,-0.43612,0.16456],[53.6,0.46878,-0.09422,-0.41323,0.29163],[53.7,0.46157,-0.05315,-0.37819,0.40675],[53.8,0.45747,-0.03244,-0.3324,0.50627],[53.9,0.45433,-0.03389,-0.27757,0.58699],[54,0.44998,-0.05651,-0.21571,0.64641],[54.1,0.44244,-0.09669,-0.14905,0.68308],[54.2,0.43024,-0.14882,-0.07986,0.69683],[54.3,0.41251,-0.20607,-0.01041,0.68874],[54.4,0.38909,-0.26144,0.05723,0.66102],[54.5,0.3605,-0.30862,0.12123,0.61656],[54.6,0.3278,-0.34273,0.18009,0.55862],[54.7,0.29249,-0.36062,0.23262,0.49037],[54.8,0.25627,-0.36103,0.27792,0.41468],[54.9,0.22086,-0.34441,0.31538,0.33394],[55,0.18789,-0.31266,0.3446,0.25007],[55.1,0.15873,-0.26879,0.36534,0.16454],[55.2,0.13441,-0.2166,0.37749,0.07844],[55.3,0.11555,-0.16036,0.38104,-0.00736],[55.4,0.10232,-0.10449,0.37606,-0.09209],[55.5,0.09449,-0.05332,0.36268,-0.17502],[55.6,0.09137,-0.01079,0.34114,-0.25525],[55.7,0.09193,0.01979,0.31176,-0.33172],[55.8,0.09485,0.03602,0.27497,-0.40305],[55.9,0.09861,0.03665,0.23137,-0.46758],[56,0.10166,0.02179,0.18174,-0.52335],[56.1,0.10251,-0.00696,0.12707,-0.56822],[56.2,0.09991,-0.04652,0.06854,-0.60002],[56.3,0.09298,-0.09255,0.00757,-0.61678],[56.4,0.08135,-0.13982,-0.05427,-0.61701],[56.5,0.06517,-0.18279,-0.11526,-0.59991],[56.6,0.04511,-0.21627,-0.17367,-0.56552],[56.7,0.02237,-0.23607,-0.22781,-0.51476],[56.8,-0.00155,-0.23951,-0.27613,-0.44931],[56.9,-0.02495,-0.2257,-0.31726,-0.37143],[57,-0.04615,-0.1956,-0.35009,-0.28369],[57.1,-0.06362,-0.15188,-0.37376,-0.1888],[57.2,-0.0762,-0.09854,-0.3877,-0.08945],[57.3,-0.08317,-0.0405,-0.39159,0.01176],[57.4,-0.08432,0.01693,-0.38537,0.11229],[57.5,-0.07998,0.0685,-0.36924,0.20962],[57.6,-0.07097,0.10957,-0.34364,0.30125],[57.7,-0.05854,0.13654,-0.30926,0.38462],[57.8,-0.04421,0.14725,-0.26707,0.45726],[57.9,-0.02965,0.14122,-0.21825,0.51692],[58,-0.01648,0.11979,-0.16418,0.56171],[58.1,-0.00611,0.08592,-0.10644,0.59038],[58.2,0.00043,0.04389,-0.04667,0.6024],[58.3,0.00257,-0.00125,0.01349,0.59805],[58.4,0.00025,-0.04428,0.07243,0.57834],[58.5,-0.00606,-0.08039,0.1287,0.54488],[58.6,-0.01547,-0.1057,0.18101,0.49959],[58.7,-0.02675,-0.11757,0.22829,0.44456],[58.8,-0.03849,-0.11471,0.26966,0.38178],[58.9,-0.0492,-0.09722,0.30445,0.31308],[59,-0.05748,-0.06639,0.33214,0.24],[59.1,-0.06211,-0.02454,0.35235,0.1638],[59.2,-0.06213,0.0252,0.36483,0.0855],[59.3,-0.05693,0.07918,0.36941,0.00596],[59.4,-0.04628,0.13347,0.366,-0.07409],[59.5,-0.03036,0.18404,0.35459,-0.15391],[59.6,-0.00972,0.22709,0.33525,-0.23265],[59.7,0.0147,0.25925,0.30813,-0.3093],[59.8,0.04167,0.27786,0.27351,-0.38254],[59.9,0.06976,0.28127,0.23179,-0.45076],[60,0.0974,0.26905,0.18359,-0.51195]];
</script>
<script id="csdraw" type="text/x-cindyscript">
Ketinit();

Setax(["a"]);
Setwindow([-6,6],[-7,2]);


R=1; I0=0.05; m1=1; m2=1.05; L0=4;
str="L0=4;m1=1;m2=1.05";
str=Textedit(60);//
tmp1=Strsplit(str,";");
forall(tmp1,
  tmp=Strsplit(#,"=");
  if(length(tmp)>1,
    if(length(tmp_2)>0,
      parse(#+";");
    );
  );
);
str="dphi=0.6";
str=Textedit(61);//
tmp=Strsplit(str,"=");
if(length(tmp_2)>0,
  parse(str+";");
);


 eqP="Q";
 eqF="G";
 eq="[P,Q,F,G]'="+text([eqP,eqQ,eqF,eqG]);
 repnm=["R","I0","m1","m2","g","L0"];
 repva=[R,I0,m1,m2,9.8,L0];
 rep=apply(1..(length(repnm)),[repnm_#,repva_#]);
 rep=flatten(rep);
 eqn=Assign(eq,rep);
 vL=Deqdata(eqn,"t=[0,60]",0,[0,0,0,dphi],600);


pt0=[0,0];
R=1;
L0=4;

Circledata("1",[pt0,R]);
Shade("1",["cr1"],["Color=[0,0,0,0.2]"]);

mf(s):=(
 regional(tmp,phi,psi,p1,p2,q1,q2);
 tmp=min(apply(1..(length(vL)),|vL_#_1-s|));
 tmp=select(1..(length(vL)),|vL_#_1-s|==tmp);
 tmp=tmp_1;
 psi=vL_tmp_2;
 phi=vL_tmp_4;
 p1=R*[cos(phi),sin(phi)];
 p2=p1+(L0+R*(phi-psi))*[sin(phi),-cos(phi)];
 p3=R*[cos(psi),sin(psi)];
 q1=R*[-1,0];
 q2=q1+[0,-L0-R*psi];
 Listplot("1",[p1,p2],["dr,2"]);
 Listplot("2",[q1,q2],["dr,2"]);
 Listplot("3",[pt0,p3],["dr,2","Color=blue"]);
 Partcrv("1",p1,q1,"cr1",["dr,2"]);
 Pointdata("1",[p2,q2],["Size=8","Color=red"]);
 Expr([0.5,1.5],"e","t="+Sprintf(s,2),["Size=1.5"]);
);

ss=Animationparam(0,1,[0,60]);
mf(ss);

Windispg();
;
</script>
    <script type="text/javascript">
var cdy = CindyJS({
  scripts: "cs*",
  use: ["katex"],
  defaultAppearance: {
    dimDependent: 0.7,
    fontFamily: "sans-serif",
    lineSize: 1,
    pointSize: 5.0,
    textsize: 12.0
  },
  angleUnit: "",
  geometry: [
    {name: "SW", type: "Free", pos: [-3.4285714285714284, -4.0, 0.5714285714285714], color: [1.0,1.0,1.0], labeled: false, size: 2.0, border:false },
    {name: "NE", type: "Free", pos: [4.0, 1.3333333333333333, 0.6666666666666666], color: [1.0,1.0,1.0], labeled: false, size: 2.0, border:false },
    {name: "Text61", type: "EditableText", pos: [-6.7,-6.5,1], color: [0.0, 0.0, 0.0], text: "dphi=0.6", textsize: 23},
    {name: "Text71", type: "Button", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.27272728085517883, pinned: true, script: "resetclock();\nplayanimation();\nAnimeflg=1;\nDirflg=1;\nsorg=Current;\n", text: "Play", textsize: 21, pos: [0.2,-6.5,1]},
    {name: "Text72", type: "Button", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.27272728085517883, script: "Animeflg=1-Animeflg;\nif(Animeflg==0,\n  pauseanimation();\n  sorg=sstart;\n,\n  resetclock();\n  playanimation();\n);", text: "Pause", textsize: 21, pos: [1.48,-6.5,1]},
    {name: "Text73", type: "Button", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.27272728085517883, script: "sorg=sstart;\nDirflg=-Dirflg;\nAnimeflg=1;\nresetclock();\nplayanimation();", text: "Rev", textsize: 21, pos: [3.06,-6.5,1]},
    {name: "Text74", type: "Button", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.27272728085517883, pinned: true, script: "stopanimation();\nAnimeflg=\"\";\nsstart=Current;\n", text: "Stop", textsize: 21, pos: [4.22,-6.5,1]},
    {name: "Text60", type: "EditableText", pos: [-6.7,-5.7,1], color: [0.0, 0.0, 0.0], text: "L0=4;m1=1;m2=1.05", textsize: 23}
  ],
  ports: [{
    id: "CSCanvas",
    width: 689,
    height: 510,
    transform: [{visibleRect: [-7,2.5,6.5,-7.5]}],
    grid: 1.0,
    snap: true,
    background: "rgb(247,247,247)"
  }],
  csconsole: false,
  cinderella: {build: 1901, version: [2, 9, 1901]}
});
    </script>
</head>
<body>
    <div id="CSCanvas"></div>
</body>
</html>
